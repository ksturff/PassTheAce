<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pass the Ace - Deluxe Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #111;
      overflow: hidden;
      color: white;
      font-family: 'Orbitron', sans-serif;
    }
    canvas {
      display: none;
    }
    #ui {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      z-index: 10;
    }
    button {
      margin: 5px;
      padding: 12px 25px;
      font-size: 18px;
      background: linear-gradient(45deg, #444, #888);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 10px #00f7ff;
      transition: 0.3s;
    }
    button:hover {
      background: linear-gradient(45deg, #666, #aaa);
      box-shadow: 0 0 20px #00f7ff;
    }
    #turnIndicator {
      position: absolute;
      top: 60px;
      width: 100%;
      text-align: center;
      font-size: 20px;
      color: #0ff;
      text-shadow: 0 0 5px #0ff;
    }
    #endOverlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      color: white;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 20;
    }
    #endOverlay button {
      font-size: 22px;
      margin-top: 20px;
      background: #28a745;
      box-shadow: 0 0 15px #28a745;
    }
    #playerContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .player-ui {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-family: 'Orbitron', sans-serif;
      pointer-events: none;
    }
    .player-card {
      width: 60px;
      height: 90px;
    }
    .player-right {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #fff;
    }
    .name {
      font-size: 12px;
      margin-top: 4px;
    }
    .chips {
      font-size: 12px;
      margin-top: 2px;
    }
    .active-player .avatar {
      box-shadow: 0 0 10px 3px #ff0;
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="startBtn" onclick="startGame()">Start Game</button>
    <div id="actionBtns" style="display:none;">
      <button onclick="keepCard()">Keep</button>
      <button onclick="passCard()">Pass</button>
    </div>
  </div>
  <div id="turnIndicator"></div>
  <div id="endOverlay">
    <div id="winMessage">Player X Wins!</div>
    <button onclick="restartGame()">Play Again</button>
  </div>
  <div id="playerContainer"></div>
  <script>
    let players = [], currentPlayer = 0, deck = [], dealerIndex = null, peekPlayerCard = false, startingPlayerIndex = 0;
    const container = document.getElementById("playerContainer");

    function getCardValue(card) {
      if (!card) return 99;
      if (typeof card.rank === 'number') return card.rank;
      return { J: 11, Q: 12, K: 13, A: 1 }[card.rank];
    }

    function createDeck() {
      let d = [];
      for (let s of ['S','H','D','C']) {
        for (let r of [2,3,4,5,6,7,8,9,10,'J','Q','K','A']) {
          d.push({suit: s, rank: r});
        }
      }
      return d.sort(() => Math.random() - 0.5);
    }

    function createPlayerElements(players) {
      container.innerHTML = "";
      const radiusX = 360, radiusY = 200;
      players.forEach((p, i) => {
        const angle = (2 * Math.PI / players.length) * i - Math.PI / 2;
        const x = 512 + Math.cos(angle) * radiusX;
        const y = 300 + Math.sin(angle) * radiusY;

        const el = document.createElement("div");
        el.className = "player-ui";
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        el.style.transform = "translate(-50%, -50%)";
        el.id = `player-${p.id}`;

        const cardImg = document.createElement("img");
        cardImg.className = "player-card";
        cardImg.src = "./assets/Back.png";

        const rightDiv = document.createElement("div");
        rightDiv.className = "player-right";

        const avatar = document.createElement("img");
        avatar.className = "avatar";
        avatar.src = "./assets/avatar.png";
        rightDiv.appendChild(avatar);

        const name = document.createElement("div");
        name.className = "name";
        name.innerText = `Player ${p.id}`;
        rightDiv.appendChild(name);

        const chips = document.createElement("div");
        chips.className = "chips";
        chips.innerText = `Chips: ${p.chips}`;
        rightDiv.appendChild(chips);

        el.appendChild(cardImg);
        el.appendChild(rightDiv);
        container.appendChild(el);
      });
    }

    function updatePlayerStates(players, currentPlayer) {
      players.forEach(p => {
        const el = document.getElementById(`player-${p.id}`);
        if (!el) return;
        const cardImg = el.querySelector(".player-card");
        const chipsEl = el.querySelector(".chips");
        const isHuman = p.id === 1;
        const showCard = isHuman || p.card?.rank === "K";

        if (p.card && showCard) {
          const rankMap = { J: 'jack', Q: 'queen', K: 'king', A: 'ace' };
          const suitMap = { S: 'spades', H: 'hearts', D: 'diamonds', C: 'clubs' };
          const rank = typeof p.card.rank === 'number' ? p.card.rank : rankMap[p.card.rank];
          const suit = suitMap[p.card.suit];
          cardImg.src = `./assets/${rank}_of_${suit}.png`;
        } else {
          cardImg.src = "./assets/Back.png";
        }

        chipsEl.innerText = `Chips: ${p.chips}`;
        el.classList.toggle("active-player", p.id === players[currentPlayer]?.id);
      });
    }

    function startGame() {
      document.getElementById("startBtn").style.display = 'none';
      deck = createDeck();
      players = Array.from({ length: 10 }, (_, i) => ({ id: i + 1, chips: 3, card: null }));
      createPlayerElements(players);
      dealCards();
    }

    function dealCards() {
      if (deck.length < players.length + 1) deck = createDeck();
      players.forEach(p => p.card = deck.pop());
      const maxVal = Math.max(...players.map(p => getCardValue(p.card)));
      const top = players.find(p => getCardValue(p.card) === maxVal);
      dealerIndex = players.indexOf(top);
      startingPlayerIndex = (dealerIndex + 1) % players.length;
      players.forEach(p => p.card = null); // Clear cards before reveal
      currentPlayer = startingPlayerIndex;
      updatePlayerStates(players, currentPlayer);
      revealCardsSequentially();
      processTurn();
    }

    function processTurn() {
      if (players.length === 0) return;
      if (currentPlayer >= players.length) currentPlayer = 0;
      const player = players[currentPlayer];
      peekPlayerCard = (player.id === 1);
      updatePlayerStates(players, currentPlayer);
      document.getElementById("turnIndicator").innerText = `Player ${player.id}'s Turn`;

      if (player.id === 1) {
        document.getElementById("actionBtns").style.display = "block";
      } else {
        document.getElementById("actionBtns").style.display = "none";
        setTimeout(() => aiTurn(), 1000);
      }
    }

    function keepCard() {
      document.getElementById("actionBtns").style.display = "none";
      peekPlayerCard = false;
      nextTurn();
    }

    function passCard() {
      const curr = players[currentPlayer];
      const next = players[(currentPlayer + 1) % players.length];
      if (!curr.card || !next.card || curr.card.rank === "K" || next.card.rank === "K") return;
      [curr.card, next.card] = [next.card, curr.card];
      document.getElementById("actionBtns").style.display = "none";
      peekPlayerCard = false;
      nextTurn();
    }

    function aiTurn() {
      const curr = players[currentPlayer];
      const next = players[(currentPlayer + 1) % players.length];
      if (!curr.card || !next.card) return nextTurn();
      if (getCardValue(curr.card) < 8 && next.card.rank !== "K") {
        [curr.card, next.card] = [next.card, curr.card];
      }
      nextTurn();
    }

    function nextTurn() {
      currentPlayer = (currentPlayer + 1) % players.length;
      if (currentPlayer === dealerIndex) {
        endRound();
      } else {
        processTurn();
      }
    }

    function endRound() {
      const min = Math.min(...players.map(p => getCardValue(p.card)));
      players.forEach(p => {
        if (getCardValue(p.card) === min) p.chips--;
      });
      players = players.filter(p => p.chips > 0);
      if (players.length === 1) {
        document.getElementById("winMessage").innerText = `ðŸ† Player ${players[0].id} Wins!`;
        document.getElementById("endOverlay").style.display = "flex";
        return;
      }
      const losers = players.filter(p => getCardValue(p.card) === min);
      const loserIndex = players.findIndex(p => p.id === losers[0].id);
      startingPlayerIndex = (loserIndex + 1) % players.length;
      deck = createDeck();
      players.forEach(p => p.card = null);
      createPlayerElements(players);
      dealCards();
    }

    function revealCardsSequentially(index = 0) {
      if (index >= players.length) {
        processTurn();
        return;
      }
      const revealIndex = (startingPlayerIndex + index) % players.length;
      players[revealIndex].card = deck.pop();
      updatePlayerStates(players, currentPlayer);
      setTimeout(() => revealCardsSequentially(index + 1), 400);
    }

    function restartGame() {
      document.getElementById("endOverlay").style.display = "none";
      document.getElementById("startBtn").style.display = "block";
    }
  </script>
</body>
</html>
