<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pass the Ace - Deluxe Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #111;
      overflow: hidden;
      color: white;
      font-family: 'Orbitron', sans-serif;
    }
    canvas {
      display: block;
      margin: auto;
      background-color: #0d0d0d;
    }
    #ui {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      z-index: 10;
    }
    button {
      margin: 5px;
      padding: 12px 25px;
      font-size: 18px;
      background: linear-gradient(45deg, #444, #888);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 10px #00f7ff;
      transition: 0.3s;
    }
    button:hover {
      background: linear-gradient(45deg, #666, #aaa);
      box-shadow: 0 0 20px #00f7ff;
    }
    #turnIndicator {
      position: absolute;
      top: 60px;
      width: 100%;
      text-align: center;
      font-size: 20px;
      color: #0ff;
      text-shadow: 0 0 5px #0ff;
    }
    #gameLog {
      position: absolute;
      top: 120px;
      left: 10px;
      width: 400px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 14px;
      color: #0f0;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      z-index: 99;
      border-radius: 8px;
      font-family: monospace;
    }
    #endOverlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      color: white;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 20;
    }
    #endOverlay button {
      font-size: 22px;
      margin-top: 20px;
      background: #28a745;
      box-shadow: 0 0 15px #28a745;
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="startBtn" onclick="startGame()">Start Game</button>
    <div id="actionBtns" style="display:none;">
      <button onclick="keepCard()">Keep</button>
      <button onclick="passCard()">Pass</button>
    </div>
  </div>
  <div id="turnIndicator"></div>
  <div id="gameLog"></div>
  <div id="endOverlay">
    <div id="winMessage">Player X Wins!</div>
    <button onclick="restartGame()">Play Again</button>
  </div>
  <canvas id="gameCanvas" width="1024" height="600"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const backgroundImage = new Image();
backgroundImage.src = './assets/background.png';
const CARD_W = 40, CARD_H = 60, CENTER_X = 512, CENTER_Y = 300;
let players = [], dealerIndex = null, currentPlayer = 0, deck = [], dealerCard = null;
let isHumanTurn = false, peekPlayerCard = false, floatingTexts = [], startingPlayerIndex = null;
let gameRunning = false;
let firstRound = true;

function getCardValue(card) {
  if (!card) return 99;
  if (typeof card.rank === 'number') return card.rank;
  return { J: 11, Q: 12, K: 13, A: 1 }[card.rank];
}

function logGameAction(message) {
  const logDiv = document.getElementById('gameLog');
  const timestamp = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.textContent = `[${timestamp}] ${message}`;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
}

function createDeck() {
  let d = [];
  for (let s of ['S','H','D','C']) {
    for (let r of [2,3,4,5,6,7,8,9,10,'J','Q','K','A']) {
      d.push({suit: s, rank: r});
    }
  }
  return d.sort(() => Math.random() - 0.5);
}

window.startGame = function () {
  document.getElementById("startBtn").style.display = 'none';
  logGameAction("Game started. Shuffling and dealing initial cards.");
  deck = createDeck();
  players = Array.from({ length: 10 }, (_, i) => ({ id: i + 1, chips: 3, card: null }));

  players.forEach(p => {
    p.card = deck.pop();
    logGameAction(`Player ${p.id} draws initial card: ${p.card.rank}${p.suit}`);
  });

  let maxVal = Math.max(...players.map(p => getCardValue(p.card)));
  let topCandidates = players.filter(p => getCardValue(p.card) === maxVal);
  dealerIndex = players.indexOf(topCandidates[0]);
  logGameAction(`Dealer determined: Player ${players[dealerIndex].id}`);

  players.forEach(p => p.card = null);
  startingPlayerIndex = (dealerIndex + 1) % players.length;
  currentPlayer = startingPlayerIndex;
  firstRound = false;
  gameRunning = true;
  dealCards();
};

function dealCards() {
  if (deck.length < players.length + 1) deck = createDeck();

  if (!firstRound) {
    dealerIndex = (dealerIndex + 1) % players.length;
    startingPlayerIndex = (dealerIndex + 1) % players.length;
  }

  players.forEach(p => p.card = null);
  dealerCard = deck.pop();
  logGameAction(`Dealer draws a hidden card.`);

  currentPlayer = startingPlayerIndex;

  players.forEach(p => {
    p.card = deck.pop();
    logGameAction(`Player ${p.id} is dealt a card.`);
  });

  logGameAction(`New round begins. Dealer is Player ${players[dealerIndex].id}`);
  logGameAction(`Starting with Player ${players[currentPlayer].id}`);

  document.getElementById("actionBtns").style.display = currentPlayer === 0 ? "block" : "none";
  updateTurnIndicator();
}

function updateTurnIndicator() {
  document.getElementById("turnIndicator").innerText =
    `Current Player: Player ${players[currentPlayer].id}`;
}

function keepCard() {
  logGameAction(`Player ${players[currentPlayer].id} chose to KEEP their card.`);
  advanceTurn();
}

function passCard() {
  let next = (currentPlayer + 1) % players.length;
  const current = players[currentPlayer];
  const nextPlayer = players[next];

  if (!nextPlayer) {
    logGameAction("Error: No next player to pass to.");
    return;
  }

  logGameAction(`Player ${current.id} passes ${current.card.rank}${current.card.suit} to Player ${nextPlayer.id}`);
  [current.card, nextPlayer.card] = [nextPlayer.card, current.card];

  advanceTurn();
}

function advanceTurn() {
  currentPlayer = (currentPlayer + 1) % players.length;
  if (currentPlayer === dealerIndex) {
    logGameAction("All players have played. Round over.");
    endRound();
    return;
  }

  updateTurnIndicator();
  document.getElementById("actionBtns").style.display = currentPlayer === 0 ? "block" : "none";
  logGameAction(`Now it's Player ${players[currentPlayer].id}'s turn.`);
}

function endRound() {
  const lowestVal = Math.min(...players.map(p => getCardValue(p.card)));
  const losers = players.filter(p => getCardValue(p.card) === lowestVal);
  losers.forEach(loser => {
    loser.chips--;
    logGameAction(`Player ${loser.id} loses a chip. (${loser.chips} remaining)`);
  });

  players = players.filter(p => p.chips > 0);
  if (players.length === 1) {
    endGame(players[0]);
  } else {
    dealCards();
  }
}

function endGame(winner) {
  gameRunning = false;
  document.getElementById("endOverlay").style.display = "flex";
  document.getElementById("winMessage").innerText = `Player ${winner.id} Wins!`;
  logGameAction(`üèÜ Player ${winner.id} has won the game!`);
}

function restartGame() {
  window.location.reload();
}
</script>
</body>
</html>
