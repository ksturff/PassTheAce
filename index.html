<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pass the Ace - Deluxe Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      background: #111;
      overflow: hidden;
      color: white;
      font-family: 'Orbitron', sans-serif;
    }
    canvas {
      display: block;
    }
    #ui {
      position: absolute;
      bottom: 40px;
      right: 40px;
      text-align: right;
      z-index: 10;
    }
    button {
      margin: 5px;
      padding: 12px 25px;
      font-size: 18px;
      background: linear-gradient(45deg, #444, #888);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 10px #00f7ff;
      transition: 0.3s;
    }
    button:hover {
      background: linear-gradient(45deg, #666, #aaa);
      box-shadow: 0 0 20px #00f7ff;
    }
    #turnIndicator {
      position: absolute;
      top: 60px;
      width: 100%;
      text-align: center;
      font-size: 20px;
      color: #0ff;
      text-shadow: 0 0 5px #0ff;
    }
    #endOverlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      color: white;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 20;
    }
    #endOverlay button {
      font-size: 22px;
      margin-top: 20px;
      background: #28a745;
      box-shadow: 0 0 15px #28a745;
    }
    #playerContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .player-ui {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-family: 'Orbitron', sans-serif;
      pointer-events: none;
    }
    .player-card {
      width: 60px;
      height: 90px;
    }
    .player-right {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #fff;
    }
    .name {
      font-size: 12px;
      margin-top: 4px;
    }
    .chips {
      font-size: 12px;
      margin-top: 2px;
    }
    .active-player .avatar {
      box-shadow: 0 0 10px 3px #ff0;
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="startBtn" onclick="startGame()" disabled>Start Game</button><br>
    <button onclick="setRadii(380,190)">Test 1</button>
    <button onclick="setRadii(360,210)">Test 2</button>
    <button onclick="setRadii(350,230)">Test 3</button>
    <div id="actionBtns" style="display:none;">
      <button onclick="keepCard()">Keep</button>
      <button onclick="passCard()">Pass</button>
    </div>
  </div>
  <div id="turnIndicator"></div>
  <div id="endOverlay">
    <div id="winMessage">Player X Wins!</div>
    <button onclick="restartGame()">Play Again</button>
  </div>
  <div id="playerContainer"></div>

  <script>
    const canvas = document.createElement('canvas');
    canvas.width = 1024;
    canvas.height = 600;
    canvas.style.position = 'absolute';
    canvas.style.left = '50%';
    canvas.style.top = '50%';
    canvas.style.transform = 'translate(-50%, -50%)';
    document.body.insertBefore(canvas, document.getElementById('playerContainer'));
    const ctx = canvas.getContext('2d');

    const backgroundImage = new Image();
    backgroundImage.src = './assets/background.png';

    const CARD_W = 70, CARD_H = 100;
    const CENTER_X = 512, CENTER_Y = 300;
    let X_RADIUS = 430, Y_RADIUS = 150;

    let players = [], dealerIndex = null, currentPlayer = 0, deck = [], dealerCard = null;
    let isHumanTurn = false, peekPlayerCard = false, startingPlayerIndex = null;
    let gameRunning = false;

    function setRadii(x, y) {
      X_RADIUS = x;
      Y_RADIUS = y;
      drawTable();
    }

    function getCardValue(card) {
      if (!card) return 99;
      if (typeof card.rank === 'number') return card.rank;
      return { J: 11, Q: 12, K: 13, A: 1 }[card.rank];
    }

    function createDeck() {
      let d = [];
      for (let s of ['S','H','D','C']) {
        for (let r of [2,3,4,5,6,7,8,9,10,'J','Q','K','A']) {
          d.push({suit: s, rank: r});
        }
      }
      return d.sort(() => Math.random() - 0.5);
    }

    function preloadAssets() {
      window.cardImages = {};
      const suits = ['clubs', 'diamonds', 'hearts', 'spades'];
      const ranks = [2,3,4,5,6,7,8,9,10,'jack','queen','king','ace'];
      const loadPromises = [];

      for (let s of suits) {
        for (let r of ranks) {
          const img = new Image();
          const src = `./assets/${r}_of_${s}.png`;
          img.src = src;
          cardImages[`${r}_${s}`] = img;
          loadPromises.push(new Promise((resolve) => {
            img.onload = resolve;
            img.onerror = resolve;
          }));
        }
      }

      const back = new Image();
      back.src = './assets/Back.png';
      cardImages['Back'] = back;
      loadPromises.push(new Promise((resolve) => {
        back.onload = resolve;
        back.onerror = resolve;
      }));

      return Promise.all(loadPromises);
    }

    function animateCardPass(fromPlayer, toPlayer, callback) {
      const fromEl = document.getElementById(`player-ui-${fromPlayer.id}`)?.querySelector('.player-card');
      const toEl = document.getElementById(`player-ui-${toPlayer.id}`)?.querySelector('.player-card');
      if (!fromEl || !toEl) return callback();

      const clone = fromEl.cloneNode(true);
      document.body.appendChild(clone);

      const fromRect = fromEl.getBoundingClientRect();
      const toRect = toEl.getBoundingClientRect();

      clone.style.position = 'absolute';
      clone.style.left = fromRect.left + 'px';
      clone.style.top = fromRect.top + 'px';
      clone.style.width = fromRect.width + 'px';
      clone.style.height = fromRect.height + 'px';
      clone.style.transition = 'all 0.6s ease-in-out';
      clone.style.zIndex = 1000;

      requestAnimationFrame(() => {
        clone.style.left = toRect.left + 'px';
        clone.style.top = toRect.top + 'px';
      });

      setTimeout(() => {
        document.body.removeChild(clone);
        callback();
      }, 600);
    }

    window.restartGame = function () {
      document.getElementById("endOverlay").style.display = "none";
      document.getElementById("startBtn").style.display = "block";
      dealerIndex = null;
      startGame();
    };

    window.startGame = function () {
      document.getElementById("startBtn").style.display = 'none';
      deck = createDeck();
      players = Array.from({ length: 10 }, (_, i) => ({
        id: i + 1,
        chips: 3,
        card: null,
        seatIndex: i
      }));
      dealCards();
      gameRunning = true;
    };

    function dealCards() {
      if (deck.length < players.length + 1) deck = createDeck();
      players.forEach(p => p.card = null);
      const sample = players.map(p => ({ ...p, card: deck.pop() }));
      let maxVal = Math.max(...sample.map(p => getCardValue(p.card)));
      let topCandidates = sample.filter(p => getCardValue(p.card) === maxVal);
      dealerIndex = players.findIndex(p => p.id === topCandidates[0].id);
      startingPlayerIndex = (dealerIndex + 1) % players.length;
      currentPlayer = startingPlayerIndex;
      sample.forEach((p, i) => players[i].card = p.card);
      revealCardsSequentially();
    }

    function revealCardsSequentially(index = 0) {
      if (index >= players.length) return processTurn();
      drawTable(false);
      setTimeout(() => revealCardsSequentially(index + 1), 300);
    }

    window.keepCard = function () {
      document.getElementById("actionBtns").style.display = "none";
      peekPlayerCard = false;
      currentPlayer = (currentPlayer + 1) % players.length;
      if (currentPlayer === dealerIndex) setTimeout(endRound, 1000);
      else processTurn();
    };

    window.passCard = function () {
      const current = players[currentPlayer];
      const next = players[(currentPlayer + 1) % players.length];
      if (!current.card || !next.card) return;
      if (current.card.rank === "K" || next.card.rank === "K") return;

      animateCardPass(current, next, () => {
        [current.card, next.card] = [next.card, current.card];
        document.getElementById("actionBtns").style.display = "none";
        peekPlayerCard = false;
        currentPlayer = (currentPlayer + 1) % players.length;
        if (currentPlayer === dealerIndex) setTimeout(endRound, 1000);
        else processTurn();
      });
    };

    function aiTurn() {
      const current = players[currentPlayer];
      const next = players[(currentPlayer + 1) % players.length];
      if (!current.card || !next.card) {
        currentPlayer = (currentPlayer + 1) % players.length;
        return processTurn();
      }
      let shouldPass = getCardValue(current.card) < 8 && next.card.rank !== "K";
      if (shouldPass) {
        animateCardPass(current, next, () => {
          [current.card, next.card] = [next.card, current.card];
          currentPlayer = (currentPlayer + 1) % players.length;
          currentPlayer === dealerIndex ? setTimeout(endRound, 1000) : processTurn();
        });
      } else {
        currentPlayer = (currentPlayer + 1) % players.length;
        currentPlayer === dealerIndex ? setTimeout(endRound, 1000) : processTurn();
      }
    }

    function processTurn() {
      if (currentPlayer >= players.length) currentPlayer = 0;
      const player = players[currentPlayer];
      isHumanTurn = (player.id === 1);
      peekPlayerCard = isHumanTurn;
      updateTurnIndicator();
      requestAnimationFrame(() => drawTable(false));
      if (isHumanTurn) {
        document.getElementById("actionBtns").style.display = "block";
      } else {
        document.getElementById("actionBtns").style.display = "none";
        setTimeout(aiTurn, 1000);
      }
    }

    function endRound() {
      drawTable(true);
      setTimeout(() => {
        const minValue = Math.min(...players.map(p => getCardValue(p.card)));
        players.forEach(p => {
          if (getCardValue(p.card) === minValue) p.chips--;
        });
        const eliminated = players.filter(p => p.chips <= 0);
        eliminated.forEach(p => {
          const el = document.getElementById(`player-ui-${p.id}`);
          if (el) el.remove();
        });
        players = players.filter(p => p.chips > 0);
        if (players.length === 1) {
          document.getElementById("winMessage").innerText = `ðŸ† Player ${players[0].id} Wins!`;
          document.getElementById("endOverlay").style.display = "flex";
          document.getElementById("actionBtns").style.display = "none";
          return;
        }
        const losers = players.filter(p => getCardValue(p.card) === minValue);
        const firstLoser = losers[0];
        const loserIndex = players.findIndex(p => p.id === firstLoser.id);
        startingPlayerIndex = (loserIndex + 1) % players.length;
        dealerIndex = dealerIndex >= players.length ? 0 : dealerIndex;
        currentPlayer = startingPlayerIndex;
        deck = createDeck();
        players.forEach(p => p.card = null);
        setTimeout(dealCards, 1000);
      }, 1500);
    }

    function drawTable(showCards = false) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (backgroundImage.complete) {
        ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
      }
      const container = document.getElementById('playerContainer');
      const angleMap = players.map((_, i, arr) => -90 + (i * 360 / arr.length));

      players.forEach((p, i) => {
        let existing = document.getElementById(`player-ui-${p.id}`);
        if (!existing) {
          existing = document.createElement('div');
          existing.className = 'player-ui';
          existing.id = `player-ui-${p.id}`;
          const isReversed = (p.id === 3 || p.id === 4);
          existing.innerHTML = isReversed
            ? `<img class="avatar" src="./assets/avatar.png" />
               <div class="player-right">
                 <div class="name">Player ${p.id}</div>
                 <div class="chips">Chips: ${p.chips}</div>
               </div>
               <img class="player-card" />`
            : `<img class="player-card" />
               <img class="avatar" src="./assets/avatar.png" />
               <div class="player-right">
                 <div class="name">Player ${p.id}</div>
                 <div class="chips">Chips: ${p.chips}</div>
               </div>`;
          container.appendChild(existing);
        }

        const angle = angleMap[i] * (Math.PI / 180);
        const offset = (p.id === 3 || p.id === 4) ? 115 : 150;
        const x = CENTER_X + Math.cos(angle) * X_RADIUS + offset;
        const y = CENTER_Y + Math.sin(angle) * Y_RADIUS;

        existing.style.left = `${x}px`;
        existing.style.top = `${y}px`;
        existing.style.transform = 'translate(-50%, -50%)';

        existing.classList.toggle('active-player', i === currentPlayer);

        const cardEl = existing.querySelector('.player-card');
        const rankMap = { J: 'jack', Q: 'queen', K: 'king', A: 'ace' };
        const suitMap = { S: 'spades', H: 'hearts', D: 'diamonds', C: 'clubs' };
        let show = showCards || (p.id === 1 && peekPlayerCard) || (p.card && p.card.rank === 'K');
        if (p.card) {
          const rank = typeof p.card.rank === 'number' ? p.card.rank : rankMap[p.card.rank];
          const suit = suitMap[p.card.suit];
          cardEl.src = show ? `./assets/${rank}_of_${suit}.png` : './assets/Back.png';
        }
        existing.querySelector('.chips').innerText = `Chips: ${p.chips}`;
      });
    }

    preloadAssets().then(() => {
      document.getElementById("startBtn").disabled = false;
    });
  </script>
</body>
</html>
