<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pass the Ace - Deluxe Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
  <style>
    body { margin:0; background:#111; overflow:hidden; color:white; font-family:'Orbitron', sans-serif; }
    canvas { display:block; }
    #ui { position:absolute; bottom:40px; right:40px; text-align:right; z-index:10; display:none; }
    button {
      margin:5px; padding:12px 25px; font-size:18px; background:linear-gradient(45deg,#444,#888);
      color:#fff; border:none; border-radius:10px; cursor:pointer; box-shadow:0 0 10px #00f7ff; transition:0.3s;
    }
    button:hover { background:linear-gradient(45deg,#666,#aaa); box-shadow:0 0 20px #00f7ff; }
    button:disabled { opacity:.5; cursor:not-allowed; box-shadow:none; }

    #turnIndicator { position:absolute; top:60px; width:100%; text-align:center; font-size:20px; color:#0ff; text-shadow:0 0 5px #0ff; }
    #endOverlay {
      display:none; position:absolute; inset:0; background:rgba(0,0,0,.85); color:white; font-size:32px;
      display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:20;
    }
    #endOverlay button { font-size:22px; margin-top:20px; background:#28a745; box-shadow:0 0 15px #28a745; }

    #playerContainer { position:absolute; inset:0; pointer-events:none; }
    .player-ui { position:absolute; display:flex; align-items:center; gap:8px; color:white; pointer-events:none; }
    .hud { display:flex; flex-direction:column; align-items:center; gap:3px; pointer-events:none; }
    .hud .name { background:#000; color:white; font-size:10px; padding:2px 8px; border-radius:20px; text-align:center; }
    .hud .avatar { width:42px; height:42px; border-radius:50%; border:2px solid white; box-shadow:0 0 4px #000; }
    .hud .avatar.active-glow { box-shadow:0 0 12px 4px #00f7ff, 0 0 24px 6px #0ff; border-color:#0ff; }
    .hud .chips { font-size:10px; color:gold; padding:1px 4px; border-radius:10px; display:flex; align-items:center; gap:2px; }

    :root{
      --bg:#0f0f10; --card:#141518; --fg:#e8f4ff; --muted:#8aa0ad;
      --accent:#00e5ff; --accent2:#1765ff; --stroke:#22262b;
      --row:#111216; --rowHover:#1a1c22; --ok:#52c41a; --full:#ff4d4f;
    }
    #lobby{ position:absolute; inset:0; background:#0f0f10; display:none; place-items:center; z-index:50; }
    .lobby-wrap{ width:min(1100px,92vw); display:grid; grid-template-columns:260px 1fr; gap:16px; }
    .l-card{ background:var(--card); border:1px solid var(--stroke); border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,.35); }
    .l-pad{ padding:14px; }
    .l-rank{ display:flex; align-items:center; gap:10px; margin-bottom:12px; color:#c9d7e3; }
    .l-bar{ flex:1; height:8px; background:#2a2e33; border-radius:999px; overflow:hidden; }
    .l-bar>span{ display:block; height:100%; width:60%; background:linear-gradient(90deg,var(--accent2),var(--accent)); }
    .l-title{ margin:0 0 8px 0; font-size:14px; color:#b9c7d5; }
    .l-form{ display:grid; gap:8px; }
    .l-form input,.l-form select{ width:100%; padding:9px 10px; border-radius:10px; border:1px solid var(--stroke); background:#0f0f12; color:#fff; }
    .l-btn{ padding:10px 12px; border-radius:12px; border:0; cursor:pointer; font-weight:700; color:#001018;
      background:linear-gradient(90deg,var(--accent2),var(--accent)); box-shadow:0 0 18px rgba(0,229,255,.25); }
    .l-tabs{ display:flex; gap:8px; margin-bottom:10px; }
    .l-tab{ background:#1a1d22; border:1px solid var(--stroke); color:#c8d6e5; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .l-tab.active{ background:linear-gradient(90deg,var(--accent2),var(--accent)); color:#001018; font-weight:700; border:0; }
    .l-table{ border-collapse:separate; border-spacing:0 8px; width:100%; }
    .l-table thead th{ font-size:12px; letter-spacing:.4px; color:#9fb0bd; padding:0 10px 6px 10px; text-align:left; }
    .l-row{ background:var(--row); border:1px solid var(--stroke); border-radius:10px; }
    .l-row:hover{ background:var(--rowHover); }
    .l-row td{ padding:12px 10px; }
    .l-pill{ font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--stroke); color:#b5c4cf; }
    .l-status{ font-size:11px; padding:3px 8px; border-radius:999px; }
    .l-status.ok{ background:rgba(82,196,26,.15); color:#b5ffc1; border:1px solid rgba(82,196,26,.35); }
    .l-status.full{ background:rgba(255,77,79,.12); color:#ffc2c2; border:1px solid rgba(255,77,79,.35); }

    #splash { position:fixed; inset:0; background:radial-gradient(1200px 600px at 50% 0%, #16212b 0%, #0b0d10 55%, #07080a 100%); display:grid; place-items:center; z-index:9999; }
    .splash-inner{ width:min(680px,92vw); background:#11161b; border:1px solid #25303a; border-radius:16px; box-shadow:0 20px 70px rgba(0,0,0,.55); padding:28px; text-align:center; color:#e8f4ff; }
    .splash-title{ font-size:34px; letter-spacing:2px; margin:2px 0 16px 0; }
    .splash-sub{ color:#9fb0bd; margin-bottom:18px; }
    .splash-row{ display:flex; gap:10px; justify-content:center; margin-bottom:16px; }
    .splash-row input{ width:260px; padding:12px 14px; border-radius:12px; border:1px solid #2a3540; background:#0e1216; color:#e8f4ff; font-size:16px; }
    .splash-buttons{ display:flex; gap:12px; justify-content:center; }
    .splash-btn{ padding:12px 18px; border-radius:14px; border:0; cursor:pointer; font-weight:800; font-size:16px; color:#001018; background:linear-gradient(90deg,#1765ff,#00e5ff); box-shadow:0 0 18px rgba(0,229,255,.25); }
    .splash-btn.secondary{ background:#1a1f24; color:#c8d6e5; border:1px solid #2a3540; box-shadow:none; }
  </style>
</head>
<body>
  <!-- SPLASH -->
  <div id="splash">
    <div class="splash-inner">
      <div class="splash-title">PASS THE ACE</div>
      <div class="splash-sub">Choose how you want to play</div>
      <div class="splash-row"><input id="splash-name" placeholder="Enter your name" /></div>
      <div class="splash-buttons">
        <button id="btn-solo" class="splash-btn">Single Player</button>
        <button id="btn-multi" class="splash-btn secondary">Multiplayer</button>
      </div>
    </div>
  </div>

  <!-- LOBBY -->
  <div id="lobby">
    <div class="lobby-wrap">
      <aside class="l-card l-pad">
        <div class="l-rank">
          <div>(Bronze I) â€“ <span id="player-chips">5</span> Chips</div>
          <div class="l-bar"><span></span></div>
        </div>

        <div class="l-title">Players Online</div>
        <div id="players-online" style="min-height:110px; background:#0f0f12; border:1px solid var(--stroke); border-radius:10px; padding:10px">0</div>

        <div class="l-title" style="margin-top:12px">Join by Code</div>
        <div class="l-form">
          <input id="usernameInput" placeholder="Enter your name" />
          <input id="roomInput" placeholder="Enter room code" />
          <button class="l-btn" id="btn-join-code">Join</button>
        </div>

        <div class="l-foot">
          <span id="conn-status">Connectingâ€¦</span>
          <span id="clock"></span>
        </div>
      </aside>

      <main class="l-card l-pad">
        <div class="l-tabs">
          <button class="l-tab active" data-tab="all">All Games</button>
          <button class="l-tab" data-tab="my">My Games</button>
          <button class="l-tab" data-tab="tournaments">Tournaments</button>
        </div>

        <div class="l-form" style="grid-template-columns:1fr 1fr 1fr 1fr auto; align-items:center">
          <select id="sel-mode">
            <option>Classic</option><option>Sudden Death</option><option>Blind</option><option>Reverse Pass</option><option>Turbo</option>
          </select>
          <select id="sel-seats">
            <option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          </select>
          <select id="sel-pace"><option>Regular</option><option>Turbo</option></select>
          <select id="sel-buyin"><option>5 Chips</option><option>10 Chips</option><option>25 Chips</option></select>
          <button class="l-btn" id="btn-create">Create Table</button>
        </div>

        <table class="l-table" style="margin-top:10px">
          <thead><tr><th>Room</th><th>Mode</th><th>Seats</th><th>Players</th><th>Status</th><th></th></tr></thead>
          <tbody id="rooms-body"></tbody>
        </table>

        <div class="l-foot">
          <span id="tip">Tip: Create a table, then open a second tab to join.</span>
          <span id="current-room"></span>
        </div>
      </main>
    </div>

    <!-- Legacy (hidden) -->
    <div style="display:none">
      <div id="player-info" data-room="">
        <span id="player-name"></span> (<span id="player-rank">Bronze I</span>) -
        <span id="player-chips-legacy">5</span> Chips
        <progress id="xp-bar" max="200" value="150"></progress>
      </div>
      <div id="tabs">
        <div class="tab active" onclick="switchTab('all')">All Games</div>
        <div class="tab" onclick="switchTab('my')">My Games</div>
        <div class="tab" onclick="switchTab('tournaments')">Tournaments</div>
      </div>
      <div id="game-lobby"></div>
      <input id="usernameInput-legacy" type="text" placeholder="Enter your name">
      <input id="roomInput-legacy" type="text" placeholder="Enter room code">
      <button onclick="createOrJoinGame()">Create/Join Game</button>
    </div>
  </div>

  <!-- In-game UI -->
  <div id="ui">
    <button id="startBtn" onclick="startGame()" disabled>Start Game</button><br />
    <div id="actionBtns" style="display:none;">
      <button id="keepBtn" onclick="keepCard()">Keep</button>
      <button id="passBtn" onclick="passCard()">Pass</button>
    </div>

    <!-- Keep hidden; solo fills bots automatically -->
    <div id="botControls" style="display:none; margin-top:8px; text-align:right;">
      <label for="botSeats" style="font-size:14px; margin-right:6px;">Target seats:</label>
      <input id="botSeats" type="number" min="2" max="10" value="10"
             style="width:64px; padding:4px 6px; border-radius:6px; border:1px solid #333; background:#0f0f12; color:#fff;" />
      <button class="l-tab" id="btn-fill-bots" style="padding:6px 10px; margin-left:6px;">Fill with Bots</button>
    </div>
  </div>

  <div id="turnIndicator"></div>
  <div id="endOverlay">
    <div id="winMessage">Player X Wins!</div>
    <button onclick="restartGame()">Play Again</button>
  </div>

  <div id="playerContainer"></div>

  <div id="players" style="position:absolute; top:10px; left:10px; z-index:100; font-size:14px; background:#222; padding:10px; border-radius:8px; box-shadow:0 0 10px #0ff;">
    <strong>Players:</strong>
    <ul id="playerList" style="list-style:none; padding-left:0; margin-top:5px;"></ul>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== Old-layout geometry constants =====
    const CENTER_X = 512, CENTER_Y = 300;
    const X_RADIUS = 360, Y_RADIUS = 210; // ellipse for HUD ring (matches your old build)
    const CARD_W = 40, CARD_H = 55;

    var mySocketId = "", myUsername = "", myRoom = "";
    var currentTab = "all", players = [], dealerIndex = null, currentPlayer = 0, deck = [];
    var myTurn = false, peekPlayerCard = false, startingPlayerIndex = null, gameRunning = false;
    var eliminatedPlayers = [], gameState = {}, animCard = null, animStartTime = null, animationInProgress = false;
    var showAllCards = false, cardImages = {}, socket = null, backgroundImage = new Image();
    var _roomsCache = [], myRooms = {}, isSolo = false;

    // ---------- helpers ----------
    function showMessage(message, duration, color) {
      if (!duration) duration = 3000;
      if (!color) color = "#f00";
      var msgBox = document.createElement("div");
      msgBox.style.position = "fixed"; msgBox.style.top = "100px"; msgBox.style.left = "50%";
      msgBox.style.transform = "translateX(-50%)"; msgBox.style.padding = "10px 20px";
      msgBox.style.background = "#222"; msgBox.style.border = "2px solid " + color;
      msgBox.style.color = "#fff"; msgBox.style.fontSize = "14px"; msgBox.style.zIndex = "1000";
      msgBox.style.boxShadow = "0 0 10px " + color; msgBox.innerText = message;
      document.body.appendChild(msgBox); setTimeout(function(){ document.body.removeChild(msgBox); }, duration);
    }

    // Ensure unique seatIndex locally (so avatars don't stack even if server forgets)
    function normalizeSeatIndexes(arr) {
      if (!Array.isArray(arr)) return;
      const used = new Set();
      let next = 0;
      arr.forEach(p => {
        if (typeof p.seatIndex !== "number" || used.has(p.seatIndex)) {
          while (used.has(next)) next = (next + 1) % 10;
          p.seatIndex = next;
          used.add(next);
        } else {
          used.add(p.seatIndex);
        }
      });
    }

    function updatePlayerInfo(player) {
      if (!player) return;
      var nameEl = document.getElementById("player-name");
      var chipsEl = document.getElementById("player-chips");
      var chipsLegacy = document.getElementById("player-chips-legacy");
      if (nameEl) nameEl.textContent = player.name;
      if (chipsEl) chipsEl.textContent = player.chips;
      if (chipsLegacy) chipsLegacy.textContent = player.chips;
      var rankEl = document.getElementById("player-rank"); if (rankEl) rankEl.textContent = "Bronze I";
      var xp = document.getElementById("xp-bar"); if (xp) xp.value = 150;
    }

    function updateLobby(games) {
      if (!games) games = [];
      var lobby = document.getElementById("game-lobby");
      if (lobby) {
        lobby.innerHTML = "";
        var currentInfo = document.getElementById("player-info");
        var currentRoom = currentInfo && currentInfo.dataset ? currentInfo.dataset.room : "";
        var list = currentTab === "my" && currentRoom ? games.filter(function(g){ return g.roomCode === currentRoom; }) : games;
        list.forEach(function(game) {
          lobby.innerHTML += '<div class="game-room"><span>Game ' + game.roomCode + ' (' + (game.playerCount || 0) + '/' + (game.maxPlayers || 0) + ') - ' + (game.status || "Waiting") + '</span><button onclick="joinGame(\'' + game.roomCode + '\')">Join</button></div>';
        });
        if (currentTab === "tournaments") lobby.innerHTML = "<div>Coming Soon!</div>";
      }
      _roomsCache = games; renderRoomsFromCache();
    }

    function switchTab(tab) {
      currentTab = tab; updateLobby(_roomsCache);
      var tabs = document.querySelectorAll("#tabs .tab");
      if (tabs && tabs.length) {
        for (var i=0;i<tabs.length;i++) tabs[i].classList.remove("active");
        var selector = '#tabs .tab[onclick="switchTab(\'' + tab + '\')"]';
        var btn = document.querySelector(selector); if (btn) btn.classList.add("active");
      }
    }

    function createOrJoinGame() {
      var nameInput = document.getElementById("usernameInput") || document.getElementById("usernameInput-legacy");
      var roomInput = document.getElementById("roomInput") || document.getElementById("roomInput-legacy");
      var name = nameInput && nameInput.value ? nameInput.value.trim() : "";
      var room = roomInput && roomInput.value ? roomInput.value.trim() : "";
      if (!name) { alert("Please enter a name."); return; }
      myUsername = name;
      if (room) joinGame(room);
      else if (socket) socket.emit("createGame", { username: myUsername });
    }

    function joinGame(roomCode) {
      if (!myUsername) { alert("Please enter a name first."); return; }
      myRoom = roomCode; if (socket) socket.emit("join", { username: myUsername, room: roomCode });
    }

    function startGame() { if (myRoom && socket) socket.emit("startGame", myRoom); }

    function keepCard() {
      if (!myTurn) return; myTurn = false;
      var ab = document.getElementById("actionBtns"); if (ab) ab.style.display = "none";
      if (socket) socket.emit("keepCard", { room: myRoom });
    }

    function passCard() {
      if (!myTurn) return;
      var cp = players.find(function(p){ return p.id === mySocketId; });
      if (cp && cp.card && cp.card.rank === "K") { showMessage("You have a King! You cannot pass.", 3000, "#f00"); return; }
      myTurn = false;
      var ab = document.getElementById("actionBtns"); if (ab) ab.style.display = "none";
      if (socket) socket.emit("passCard", { room: myRoom });
    }

    function restartGame() {
      document.getElementById("endOverlay").style.display = "none";
      document.getElementById("startBtn").style.display = "block";
      dealerIndex = null; startGame();
    }

    function updateTurnIndicator() {
      var player = players.find(function(p){ return p.id === gameState.currentPlayerId; });
      var ti = document.getElementById("turnIndicator"); if (ti) ti.innerText = player ? (player.name + "'s Turn") : "";
    }

    // ---------- table rendering (old layout) ----------
    function drawTable(showCards, anim) {
      if (typeof showCards === "undefined") showCards = false;

      const canvas = document.querySelector("canvas");
      const ctx = canvas.getContext("2d");

      // background
      ctx.clearRect(0, 0, 1024, 600);
      if (backgroundImage.complete && backgroundImage.naturalWidth > 0) {
        ctx.drawImage(backgroundImage, 0, 0, 1024, 600);
      } else {
        ctx.fillStyle = "#222"; ctx.fillRect(0, 0, 1024, 600);
      }

      // same ring/offsets you had before
      const angleMap = Array.from({ length: 10 }, (_, i) => -90 + (i * 360 / 10));
      const radiusX = X_RADIUS - 100;
      const radiusY = Y_RADIUS - 50;

      const cardOffsets = [
        { x: 0,  y: 40 }, { x: 0,  y: 10 }, { x: 30, y: -20 }, { x: 30, y: 10 },
        { x: 0,  y: -20 },{ x: 0,  y: -50 },{ x: -5, y: -20 },
        { x: -30,y: 10 }, { x: -30,y: -20 },{ x: -5, y: 10 }
      ];

      const hudOffsets = [
        { x:130, y: 40 }, { x: 50, y: 10 }, { x:135, y: -30 }, { x:150, y: 15 },
        { x: 50, y: 30 }, { x:130, y: -10 }, { x:200, y: 30 },
        { x:110, y: 15 }, { x:110, y: -30 }, { x:200, y: 10 }
      ];

      // draw cards
      players.forEach(function(p){
        const i = (typeof p.seatIndex === "number") ? p.seatIndex : 0;
        const angle = angleMap[i] * Math.PI / 180;
        const offset = cardOffsets[i];
        p.cardX = CENTER_X + Math.cos(angle) * radiusX + offset.x;
        p.cardY = CENTER_Y + Math.sin(angle) * radiusY + offset.y;

        if (!p.card) return;
        if (anim && anim.progress < 1 && (i === anim.fromIndex || i === anim.toIndex)) return;

        const rankMap = { J:"jack", Q:"queen", K:"king", A:"ace" };
        const suitMap = { S:"spades", H:"hearts", D:"diamonds", C:"clubs" };
        const rank = (typeof p.card.rank === "number") ? p.card.rank : rankMap[p.card.rank];
        const suit = suitMap[p.card.suit];
        const key  = `${rank}_of_${suit}`;

        const show = showCards || showAllCards || (p.id === mySocketId && peekPlayerCard) || p.card.rank === "K";
        const cardImg = cardImages[show ? key : "back"];
        if (cardImg && cardImg.complete) {
          const scale = (cardImg === cardImages["back"]) ? 1.0 : 0.95;
          ctx.drawImage(cardImg, p.cardX - CARD_W/2, p.cardY - CARD_H/2, CARD_W*scale, CARD_H*scale);
        } else {
          ctx.fillStyle = "red"; ctx.fillRect(p.cardX - CARD_W/2, p.cardY - CARD_H/2, CARD_W, CARD_H);
        }
      });

      // moving card animation
      if (anim && anim.fromIndex != null && anim.toIndex != null) {
        const from = players[anim.fromIndex];
        const to   = players[anim.toIndex];
        if (from && to && from.cardX != null && to.cardX != null) {
          const x = from.cardX + (to.cardX - from.cardX) * anim.progress;
          const y = from.cardY + (to.cardY - from.cardY) * anim.progress;
          const back = cardImages["back"];
          if (back && back.complete) ctx.drawImage(back, x - CARD_W/2, y - CARD_H/2, CARD_W, CARD_H);
        }
      }

      // HUD (avatars, names, chips)
      const container = document.getElementById("playerContainer");
      container.innerHTML = "";

      players.forEach(function(p){
        const i = (typeof p.seatIndex === "number") ? p.seatIndex : 0;
        const angle  = angleMap[i] * Math.PI / 180;
        const offset = hudOffsets[i];
        const outerX = X_RADIUS + 30;
        const outerY = Y_RADIUS + 30;
        const x = CENTER_X + Math.cos(angle) * outerX + offset.x;
        const y = CENTER_Y + Math.sin(angle) * outerY + offset.y;

        const div = document.createElement("div");
        div.className = "player-ui"; div.id = "player-ui-" + p.id;
        div.style.left = x + "px"; div.style.top = y + "px";
        div.style.transform = "translate(-50%, -50%)" + ((i === currentPlayer && p.chips > 0) ? " scale(1.05)" : "");

        const hud = document.createElement("div");
        hud.className = "hud";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = p.name;
        if (p.id.indexOf("bot_") === 0) { name.style.color = "#666"; name.style.opacity = "0.7"; }

        const avatar = document.createElement("img");
        avatar.className = "avatar";
        avatar.src = "/assets/avatars/avatar.png";                // preferred folder
        avatar.onerror = function(){ this.onerror=null; this.src="/assets/avatar.png"; }; // fallback
        if (p.id.indexOf("bot_") === 0) avatar.style.opacity = "0.5";
        if (i === currentPlayer && p.chips > 0) avatar.classList.add("active-glow");

        const chips = document.createElement("div");
        chips.className = "chips";
        const coin = document.createElement("img");
        coin.src = "/assets/coin.png";
        coin.style.height = "14px";
        coin.style.verticalAlign = "middle";
        chips.appendChild(coin);
        chips.appendChild(document.createTextNode(" " + (p.chips ?? 5)));

        hud.appendChild(name);
        hud.appendChild(avatar);
        hud.appendChild(chips);
        div.appendChild(hud);
        container.appendChild(div);
      });
    }

    function animateCardPass(timestamp) {
      if (!animCard || !animationInProgress) return;
      var duration = 500;
      if (!animStartTime) animStartTime = timestamp;
      var elapsed = timestamp - animStartTime;
      var t = Math.min(elapsed / duration, 1);
      var ease = (t < 0.5) ? (2 * t * t) : (-1 + (4 - 2 * t) * t);
      animCard.progress = ease;
      drawTable(false, animCard);
      if (animCard.progress < 1) requestAnimationFrame(animateCardPass);
      else { animCard = null; animationInProgress = false; drawTable(); }
    }

    // ---------- assets ----------
    function preloadAssets() {
      var suits = ["clubs", "diamonds", "hearts", "spades"];
      var ranks = [2,3,4,5,6,7,8,9,10,"jack","queen","king","ace"];
      var ps = [];
      cardImages = {};

      suits.forEach(function(suit){
        ranks.forEach(function(rank){
          var img = new Image();
          var key = rank + "_of_" + suit;
          img.src = "/assets/" + key + ".png"; // absolute path for Render
          cardImages[key] = img;
          ps.push(new Promise(function(res){ img.onload = res; img.onerror = res; }));
        });
      });

      // back.png with a case-insensitive fallback
      var back = new Image();
      back.src = "/assets/back.png";
      back.onerror = function(){ this.onerror=null; this.src="/assets/Back.png"; };
      cardImages["back"] = back;
      ps.push(new Promise(function(res){ back.onload = res; back.onerror = res; }));

      return Promise.all(ps);
    }

    function renderRoomsFromCache() {
      var body = document.getElementById("rooms-body");
      if (!body) return; body.innerHTML = "";
      var list = _roomsCache.slice ? _roomsCache.slice(0) : [];
      if (currentTab === "my") {
        var info = document.getElementById("player-info");
        var currentRoom = info && info.dataset ? info.dataset.room : "";
        list = currentRoom ? list.filter(function(r){ return r.roomCode === currentRoom; }) : [];
      }
      if (currentTab === "tournaments") {
        body.innerHTML = '<tr class="l-row"><td colspan="6" style="padding:16px">Tournaments â€“ coming soon!</td></tr>';
        return;
      }
      var onlineEl = document.getElementById("players-online");
      if (onlineEl) {
        var total = 0; list.forEach(function(r){ total += (r.playerCount || 0); });
        onlineEl.textContent = String(total);
      }
      list.forEach(function(r){
        var tr = document.createElement("tr"); tr.className = "l-row";
        var mode = r.mode || r.type || "Classic";
        var seats = r.seats || r.maxPlayers || 8;
        var status = (r.status === "Full")
          ? '<span class="l-status full">Full</span>'
          : '<span class="l-status ok">Open</span>';
        tr.innerHTML =
          '<td><span class="l-pill">' + String(r.roomCode || "").slice(0,6) + "</span></td>" +
          "<td>" + mode + (r.buyIn ? " â€” " + r.buyIn : "") + "</td>" +
          "<td>" + seats + "</td>" +
          "<td>" + (r.playerCount || 0) + "/" + seats + "</td>" +
          "<td>" + status + "</td>" +
          '<td style="text-align:right"><button class="l-tab" data-join="' + r.roomCode + '" style="padding:6px 10px">Join</button></td>';
        body.appendChild(tr);
        var joinBtn = tr.querySelector("[data-join]"); if (joinBtn) joinBtn.addEventListener("click", function(){ joinGame(r.roomCode); });
      });
    }

    // ---------- boot ----------
    document.addEventListener("DOMContentLoaded", function(){
      socket = io();

      var splash = document.getElementById("splash");
      var splashName = document.getElementById("splash-name");
      var btnSolo = document.getElementById("btn-solo");
      var btnMulti = document.getElementById("btn-multi");
      var lobbyEl = document.getElementById("lobby");
      var lobbyNameInput = document.getElementById("usernameInput");

      function useNameOrAlert() {
        var n = splashName && splashName.value ? splashName.value.trim() : "";
        if (!n) { alert("Please enter your name"); return null; }
        myUsername = n; if (lobbyNameInput) lobbyNameInput.value = n; return n;
      }

      if (btnMulti) btnMulti.addEventListener("click", function(){
        if (!useNameOrAlert()) return;
        splash.style.display = "none"; lobbyEl.style.display = "grid";
        if (socket) socket.emit("requestLobbyState");
      });

      if (btnSolo) btnSolo.addEventListener("click", function(){
        if (!useNameOrAlert()) return;
        var opts = { mode:"Classic", seats:10, pace:"Regular", buyIn:"5 Chips" };
        if (socket) socket.emit("createGame", { username: myUsername, options: opts, singlePlayer: true });
      });

      var clockEl = document.getElementById("clock");
      if (clockEl) setInterval(function(){ clockEl.textContent = new Date().toLocaleTimeString(); }, 1000);

      var btnJoinCode = document.getElementById("btn-join-code");
      if (btnJoinCode) {
        btnJoinCode.addEventListener("click", function(){
          var nameEl = document.getElementById("usernameInput");
          var roomEl = document.getElementById("roomInput");
          var name = nameEl && nameEl.value ? nameEl.value.trim() : "";
          var room = roomEl && roomEl.value ? roomEl.value.trim() : "";
          if (!name || !room) { alert("Enter your name and room code."); return; }
          myUsername = name; joinGame(room);
        });
      }

      var btnCreate = document.getElementById("btn-create");
      if (btnCreate) {
        btnCreate.addEventListener("click", function(){
          var nameEl = document.getElementById("usernameInput");
          var name = nameEl && nameEl.value ? nameEl.value.trim() : "";
          if (!name) { alert("Please enter a name."); return; }
          myUsername = name;
          var modeEl = document.getElementById("sel-mode");
          var seatsEl = document.getElementById("sel-seats");
          var paceEl = document.getElementById("sel-pace");
          var buyEl = document.getElementById("sel-buyin");
          var opts = {
            mode: modeEl ? modeEl.value : "Classic",
            seats: seatsEl ? Number(seatsEl.value) : 8,
            pace: paceEl ? paceEl.value : "Regular",
            buyIn: buyEl ? buyEl.value : "5 Chips"
          };
          if (socket) socket.emit("createGame", { username: myUsername, options: opts });
        });
      }

      var tabBtns = document.querySelectorAll(".l-tab");
      for (var i=0;i<tabBtns.length;i++){
        tabBtns[i].addEventListener("click", function(){
          for (var j=0;j<tabBtns.length;j++) tabBtns[j].classList.remove("active");
          this.classList.add("active");
          currentTab = this.getAttribute("data-tab");
          renderRoomsFromCache();
        });
      }

      // socket events
      socket.on("connect", function(){
        mySocketId = socket.id;
        var cs = document.getElementById("conn-status");
        if (cs) cs.textContent = "Connected";
        socket.emit("requestLobbyState");
      });

      socket.on("lobbyUpdate", function(games){ updateLobby(games); });

      socket.on("roomCreated", function(roomCode){
        myRoom = roomCode;
        var cr = document.getElementById("current-room");
        if (cr) cr.textContent = "Joined: " + roomCode;
        updateLobby(_roomsCache);
      });

      socket.on("playerList", function(playersList){
        normalizeSeatIndexes(playersList);
        var pi = document.getElementById("player-info");
        if (pi) pi.dataset.room = myRoom || "";
        var me = playersList.find(function(p){ return p.id === mySocketId; });
        updatePlayerInfo(me);
        var listEl = document.getElementById("playerList");
        if (listEl) {
          listEl.innerHTML = "";
          playersList.forEach(function(p){
            var li = document.createElement("li"); li.innerText = p.name; listEl.appendChild(li);
          });
        }
        var humanCount = playersList.filter(function(p){ return p.id.indexOf("bot_") !== 0; }).length;
        var startBtn = document.getElementById("startBtn");
        if (startBtn) startBtn.disabled = isSolo ? false : (humanCount < 2);
      });

      socket.on("joinedRoom", function(data){
        myRoom   = data.roomCode;
        players  = data.players || [];
        normalizeSeatIndexes(players);
        isSolo   = !!data.singlePlayer;

        var splashEl = document.getElementById("splash"); if (splashEl) splashEl.style.display = "none";
        document.getElementById("lobby").style.display = "none";
        document.getElementById("ui").style.display = "block";

        var playerListEl = document.getElementById("playerList");
        if (playerListEl) {
          playerListEl.innerHTML = players.map(function(p){ return "<li>" + p.name + "</li>"; }).join("");
        }

        preloadAssets().then(function(){ drawTable(); });
      });

      socket.on("gameStarted", function(state){
        gameState = state; players = state.players || [];
        normalizeSeatIndexes(players);
        var splashEl = document.getElementById("splash"); if (splashEl) splashEl.style.display = "none";
        document.getElementById("lobby").style.display = "none";
        document.getElementById("ui").style.display = "block";
        preloadAssets().then(function(){ drawTable(); });
      });

      socket.on("turnUpdate", function(payload){
        var currentPlayerId = payload.currentPlayerId;
        var updatedPlayers = payload.players || [];
        normalizeSeatIndexes(updatedPlayers);
        var peekAllowed = payload.peekAllowed;
        gameState.players = updatedPlayers; gameState.currentPlayerId = currentPlayerId;
        players = updatedPlayers; myTurn = (mySocketId === currentPlayerId);
        peekPlayerCard = myTurn && (typeof peekAllowed === "undefined" || peekAllowed);
        updateTurnIndicator(); drawTable();
        var actionBtns = document.getElementById("actionBtns");
        var passBtn = document.getElementById("passBtn");
        var keepBtn = document.getElementById("keepBtn");
        if (actionBtns && passBtn && keepBtn) {
          actionBtns.style.display = myTurn ? "block" : "none";
          var cp = players.find(function(p){ return p.id === currentPlayerId; });
          var canPass = !(cp && cp.card && cp.card.rank === "K");
          passBtn.disabled = (!myTurn || !canPass); keepBtn.disabled = (!myTurn);
        }
      });

      socket.on("cardPassed", function(evt){
        var toPlayer = players[evt.toIndex];
        if (toPlayer && toPlayer.card && toPlayer.card.rank === "K") {
          showMessage(toPlayer.name + " has a King and cannot be passed to!", 3000, "#f00");
          return;
        }
        drawTable();
        animCard = { fromIndex: evt.fromIndex, toIndex: evt.toIndex, progress: 0 };
        animStartTime = null; animationInProgress = true; requestAnimationFrame(animateCardPass);
      });

      socket.on("roundEnded", function(data){
        var updatedPlayers = data.updatedPlayers || [];
        normalizeSeatIndexes(updatedPlayers);
        var losers = data.losers || [];
        gameState.players = updatedPlayers;
        players = updatedPlayers.map(p => ({ ...p }));
        myTurn = false; peekPlayerCard = false; animCard = null;
        showAllCards = true; drawTable(false, animCard);
        var frozenPlayers = players.slice(0);
        setTimeout(function(){ showAllCards = false; players = frozenPlayers; drawTable(); }, 6500);
        var alertMessage = "ðŸ’¥ Round ended! Lost a chip: " + losers.map(function(loser){
          var snap = updatedPlayers.find(function(p){ return p.name === loser.name; });
          if (!snap || !snap.card) return loser.name + " (?)";
          return loser.name + " (" + snap.card.rank + snap.card.suit + ")";
        }).join(", ");
        showMessage(alertMessage, 4500, "#f00");
      });

      socket.on("errorMessage", function(msg){ showMessage(msg, 3000, "#f00"); });

      socket.on("gameOver", function(payload){
        document.getElementById("winMessage").innerText = payload.winner.name + " Wins!";
        document.getElementById("endOverlay").style.display = "flex";
      });

      // background (absolute path; fallback case)
      backgroundImage.src = "/assets/background.png";
      backgroundImage.onerror = function(){
        this.onerror = null;
        this.src = "/assets/Background.png";
        var ctx = document.querySelector("canvas").getContext("2d");
        ctx.fillStyle = "#222"; ctx.fillRect(0, 0, 1024, 600);
      };

      // canvas wrapper
      var wrapper = document.createElement("div");
      wrapper.style.position = "absolute"; wrapper.style.left = "50%"; wrapper.style.top = "50%";
      wrapper.style.transform = "translate(-50%, -50%)"; wrapper.style.width = "1024px"; wrapper.style.height = "600px";
      wrapper.style.overflow = "hidden"; wrapper.style.zIndex = "1";

      var canvas = document.createElement("canvas");
      canvas.width = 1024; canvas.height = 600; canvas.style.display = "block";
      canvas.style.width = "100%"; canvas.style.height = "100%";

      wrapper.appendChild(canvas);
      var hudContainer = document.getElementById("playerContainer");
      wrapper.appendChild(hudContainer);
      document.body.appendChild(wrapper);

      function resizeGame() {
        var scaleX = window.innerWidth / 1024;
        var scaleY = window.innerHeight / 600;
        var scale = Math.min(scaleX, scaleY);
        wrapper.style.transform = "translate(-50%, -50%) scale(" + scale + ")";
      }
      window.addEventListener("resize", resizeGame); resizeGame();

      // Hide the bot control UI (server fills bots automatically for solo)
      // (left intentionally inert)
    });
  </script>
</body>
</html>
