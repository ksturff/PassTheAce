<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pass the Ace - Deluxe Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #111;
      overflow: hidden;
      color: white;
      font-family: 'Orbitron', sans-serif;
    }
    canvas {
      display: block;
    }
    #ui {
      position: absolute;
      bottom: 40px;
      right: 40px;
      text-align: right;
      z-index: 10;
      display: none;
    }
    button {
      margin: 5px;
      padding: 12px 25px;
      font-size: 18px;
      background: linear-gradient(45deg, #444, #888);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 10px #00f7ff;
      transition: 0.3s;
    }
    button:hover {
      background: linear-gradient(45deg, #666, #aaa);
      box-shadow: 0 0 20px #00f7ff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    #turnIndicator {
      position: absolute;
      top: 60px;
      width: 100%;
      text-align: center;
      font-size: 20px;
      color: #0ff;
      text-shadow: 0 0 5px #0ff;
    }
    #endOverlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      color: white;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 20;
    }
    #endOverlay button {
      font-size: 22px;
      margin-top: 20px;
      background: #28a745;
      box-shadow: 0 0 15px #28a745;
    }
    #playerContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .player-ui {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-family: 'Orbitron', sans-serif;
      pointer-events: none;
    }
    .hud {
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
      gap: 3px;
    }
    .hud .name {
      background: #000;
      color: white;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 20px;
      text-align: center;
    }
    .hud .avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 4px #000;
    }
    .hud .avatar.active-glow {
      box-shadow: 0 0 12px 4px #00f7ff, 0 0 24px 6px #0ff;
      border-color: #0ff;
    }
    .hud .chips {
      font-size: 10px;
      color: gold;
      background: none;
      padding: 1px 4px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    /* ===== PRO LOBBY STYLES (Step 1) ===== */
    :root{
      --bg:#0f0f10; --card:#141518; --fg:#e8f4ff; --muted:#8aa0ad;
      --accent:#00e5ff; --accent2:#1765ff; --stroke:#22262b;
      --row:#111216; --rowHover:#1a1c22; --ok:#52c41a; --full:#ff4d4f;
    }
    #lobby{position:absolute; inset:0; background:#0f0f10; display:grid; place-items:center; z-index:50}
    .lobby-wrap{width:min(1100px,92vw); display:grid; grid-template-columns:260px 1fr; gap:16px}
    .l-card{background:var(--card); border:1px solid var(--stroke); border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .l-pad{padding:14px}
    .l-rank{display:flex; align-items:center; gap:10px; margin-bottom:12px; color:#c9d7e3}
    .l-bar{flex:1; height:8px; background:#2a2e33; border-radius:999px; overflow:hidden}
    .l-bar>span{display:block; height:100%; width:60%; background:linear-gradient(90deg,var(--accent2),var(--accent));}
    .l-title{margin:0 0 8px 0; font-size:14px; color:#b9c7d5}
    .l-form{display:grid; gap:8px}
    .l-form input,.l-form select{width:100%; padding:9px 10px; border-radius:10px; border:1px solid var(--stroke); background:#0f0f12; color:#fff}
    .l-btn{padding:10px 12px; border-radius:12px; border:0; cursor:pointer; font-weight:700; color:#001018;
      background:linear-gradient(90deg,var(--accent2),var(--accent)); box-shadow:0 0 18px rgba(0,229,255,.25)}
    .l-tabs{display:flex; gap:8px; margin-bottom:10px}
    .l-tab{background:#1a1d22; border:1px solid var(--stroke); color:#c8d6e5; padding:8px 12px; border-radius:10px; cursor:pointer}
    .l-tab.active{background:linear-gradient(90deg,var(--accent2),var(--accent)); color:#001018; font-weight:700; border:0}
    .l-table{border-collapse:separate; border-spacing:0 8px; width:100%}
    .l-table thead th{font-size:12px; letter-spacing:.4px; color:#9fb0bd; padding:0 10px 6px 10px; text-align:left}
    .l-row{background:var(--row); border:1px solid var(--stroke); border-radius:10px}
    .l-row:hover{background:var(--rowHover)}
    .l-row td{padding:12px 10px}
    .l-pill{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--stroke); color:#b5c4cf}
    .l-status{font-size:11px; padding:3px 8px; border-radius:999px}
    .l-status.ok{background:rgba(82,196,26,.15); color:#b5ffc1; border:1px solid rgba(82,196,26,.35)}
    .l-status.full{background:rgba(255,77,79,.12); color:#ffc2c2; border:1px solid rgba(255,77,79,.35)}
    .l-foot{margin-top:12px; display:flex; align-items:center; justify-content:space-between; color:#8aa0ad; font-size:12px}
    /* ===== End PRO LOBBY STYLES ===== */
  </style>
</head>
<body>

  <!-- ===== NEW POLISHED LOBBY (visible) ===== -->
  <div id="lobby">
    <div class="lobby-wrap">
      <!-- Left panel -->
      <aside class="l-card l-pad">
        <div class="l-rank">
          <div>(Bronze I) – <span id="player-chips">5</span> Chips</div>
          <div class="l-bar"><span></span></div>
        </div>

        <div class="l-title">Players Online</div>
        <div id="players-online" style="min-height:110px; background:#0f0f12; border:1px solid var(--stroke); border-radius:10px; padding:10px">0</div>

        <div class="l-title" style="margin-top:12px">Join by Code</div>
        <div class="l-form">
          <input id="usernameInput" placeholder="Enter your name" />
          <input id="roomInput" placeholder="Enter room code" />
          <button class="l-btn" id="btn-join-code">Join</button>
        </div>

        <div class="l-foot">
          <span id="conn-status">Connecting…</span>
          <span id="clock"></span>
        </div>
      </aside>

      <!-- Main panel -->
      <main class="l-card l-pad">
        <div class="l-tabs">
          <button class="l-tab active" data-tab="all">All Games</button>
          <button class="l-tab" data-tab="my">My Games</button>
          <button class="l-tab" data-tab="tournaments">Tournaments</button>
        </div>

        <div class="l-form" style="grid-template-columns:1fr 1fr 1fr auto; align-items:center">
          <select id="sel-type"><option>Hold’em</option><option>Omaha</option><option>Custom</option></select>
          <select id="sel-stakes"><option>Bronze I – 5 Chips</option><option>Bronze II – 10 Chips</option><option>Silver I – 25 Chips</option></select>
          <select id="sel-speed"><option>Regular</option><option>Turbo</option></select>
          <button class="l-btn" id="btn-create">Create Table</button>
        </div>

        <table class="l-table" style="margin-top:10px">
          <thead><tr><th>Room</th><th>Type</th><th>Stakes</th><th>Players</th><th>Status</th><th></th></tr></thead>
          <tbody id="rooms-body"></tbody>
        </table>

        <div class="l-foot">
          <span id="tip">Tip: Create a table, then open a second tab to join.</span>
          <span id="current-room"></span>
        </div>
      </main>
    </div>

    <!-- ===== LEGACY LOBBY (hidden for compatibility with your current JS) ===== -->
    <div style="display:none">
      <div id="player-info" data-room="">
        <span id="player-name"></span> (<span id="player-rank">Bronze I</span>) -
        <span id="player-chips-legacy">5</span> Chips
        <progress id="xp-bar" max="200" value="150"></progress>
      </div>
      <div id="tabs">
        <div class="tab active" onclick="switchTab('all')">All Games</div>
        <div class="tab" onclick="switchTab('my')">My Games</div>
        <div class="tab" onclick="switchTab('tournaments')">Tournaments</div>
      </div>
      <div id="game-lobby"></div>
      <input id="usernameInput-legacy" type="text" placeholder="Enter your name">
      <input id="roomInput-legacy" type="text" placeholder="Enter room code">
      <button onclick="createOrJoinGame()">Create/Join Game</button>
    </div>
    <!-- ===== End legacy block ===== -->
  </div>

  <!-- ===== In-game UI (unchanged) ===== -->
  <div id="ui">
    <button id="startBtn" onclick="startGame()" disabled>Start Game</button><br>
    <div id="actionBtns" style="display:none;">
      <button id="keepBtn" onclick="keepCard()">Keep</button>
      <button id="passBtn" onclick="passCard()">Pass</button>
    </div>
  </div>
  <div id="turnIndicator"></div>
  <div id="endOverlay">
    <div id="winMessage">Player X Wins!</div>
    <button onclick="restartGame()">Play Again</button>
  </div>
  <div id="playerContainer"></div>
  <div id="players" style="position:absolute; top:10px; left:10px; z-index:100; font-size:14px; background:#222; padding:10px; border-radius:8px; box-shadow: 0 0 10px #0ff;">
    <strong>Players:</strong>
    <ul id="playerList" style="list-style:none; padding-left: 0; margin-top: 5px;"></ul>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== Your existing JS (unchanged in Step 1) =====
    // Global variables and socket
    let mySocketId = "";
    let myUsername = "";
    let myRoom = "";
    let currentTab = 'all';
    let players = [];
    let dealerIndex = null;
    let currentPlayer = 0;
    let deck = [];
    let myTurn = false;
    let peekPlayerCard = false;
    let startingPlayerIndex = null;
    let gameRunning = false;
    let eliminatedPlayers = [];
    let gameState = {};
    let animCard = null;
    let animStartTime = null;
    let animationInProgress = false;
    let showAllCards = false;
    const cardImages = {};
    let socket; // Declare socket globally
    const backgroundImage = new Image(); // Move backgroundImage to global scope

    // Global functions
    function updateLobby(games = []) {
      const lobby = document.getElementById('game-lobby');
      if (!lobby) return; // legacy fallback (until Step 2 JS update)
      lobby.innerHTML = '';
      const currentRoom = (document.getElementById('player-info') || {}).dataset?.room;
      const filteredGames = currentTab === 'my' ? games.filter(g => g.roomCode === currentRoom) : games;
      filteredGames.forEach(game => {
        lobby.innerHTML += `
          <div class="game-room">
            <span>Game ${game.roomCode} (${game.playerCount}/${game.maxPlayers}) - ${game.status}</span>
            <button onclick="joinGame('${game.roomCode}')">Join</button>
          </div>
        `;
      });
      if (currentTab === 'tournaments') lobby.innerHTML = '<div>Coming Soon!</div>';
    }

    function updatePlayerInfo(player) {
      if (player) {
        const nameEl = document.getElementById('player-name');
        const chipsEl = document.getElementById('player-chips'); // visible counter
        const chipsLegacy = document.getElementById('player-chips-legacy');
        if (nameEl) nameEl.textContent = player.name;
        if (chipsEl) chipsEl.textContent = player.chips;
        if (chipsLegacy) chipsLegacy.textContent = player.chips;
        const rankEl = document.getElementById('player-rank');
        if (rankEl) rankEl.textContent = 'Bronze I';
        const xp = document.getElementById('xp-bar');
        if (xp) xp.value = 150;
      }
    }

    function switchTab(tab) {
      currentTab = tab;
      updateLobby();
      const tabs = document.querySelectorAll('#tabs .tab');
      if (!tabs.length) return;
      tabs.forEach(t => t.classList.remove('active'));
      const btn = document.querySelector(`#tabs .tab[onclick="switchTab('${tab}')"]`);
      if (btn) btn.classList.add('active');
    }

    function createOrJoinGame() {
      const nameInput = document.getElementById('usernameInput') || document.getElementById('usernameInput-legacy');
      const roomInput = document.getElementById('roomInput') || document.getElementById('roomInput-legacy');
      const name = (nameInput?.value || '').trim();
      const room = (roomInput?.value || '').trim();
      if (!name) return alert('Please enter a name.');
      myUsername = name;
      if (room) {
        joinGame(room);
      } else {
        socket.emit('createGame', { username: myUsername });
      }
    }

    function joinGame(roomCode) {
      if (!myUsername) return alert('Please enter a name first.');
      myRoom = roomCode;
      socket.emit('join', { username: myUsername, room: roomCode });
    }

    function startGame() {
      if (myRoom) socket.emit('startGame', myRoom);
    }

    function keepCard() {
      if (myTurn) {
        myTurn = false;
        document.getElementById('actionBtns').style.display = 'none';
        socket.emit('keepCard', { room: myRoom });
      }
    }

    function passCard() {
      if (myTurn) {
        const currentPlayer = players.find(p => p.id === mySocketId);
        if (currentPlayer && currentPlayer.card && currentPlayer.card.rank === 'K') {
          showMessage('You have a King! You cannot pass.', 3000, '#f00');
          return;
        }
        myTurn = false;
        document.getElementById('actionBtns').style.display = 'none';
        socket.emit('passCard', { room: myRoom });
      }
    }

    function showMessage(message, duration = 3000, color = "#f00") {
      const msgBox = document.createElement("div");
      msgBox.style.position = "fixed";
      msgBox.style.top = "100px";
      msgBox.style.left = "50%";
      msgBox.style.transform = "translateX(-50%)";
      msgBox.style.padding = "10px 20px";
      msgBox.style.background = "#222";
      msgBox.style.border = `2px solid ${color}`;
      msgBox.style.color = "#fff";
      msgBox.style.fontSize = "14px";
      msgBox.style.zIndex = "1000";
      msgBox.style.boxShadow = `0 0 10px ${color}`;
      msgBox.innerText = message;
      document.body.appendChild(msgBox);
      setTimeout(() => { document.body.removeChild(msgBox); }, duration);
    }

    function restartGame() {
      document.getElementById("endOverlay").style.display = "none";
      document.getElementById("startBtn").style.display = "block";
      dealerIndex = null;
      startGame();
    }

    function updateTurnIndicator() {
      const player = players.find(p => p.id === gameState.currentPlayerId);
      document.getElementById("turnIndicator").innerText = player ? `${player.name}'s Turn` : '';
    }

    function drawTable(showCards = false, animCard = null) {
      const ctx = document.querySelector('canvas').getContext('2d');
      ctx.clearRect(0, 0, 1024, 600);
      if (backgroundImage.complete && backgroundImage.naturalWidth > 0) {
        ctx.drawImage(backgroundImage, 0, 0, 1024, 600);
      } else {
        ctx.fillStyle = '#222';
        ctx.fillRect(0, 0, 1024, 600);
      }

      const BASE_WIDTH = 1024;
      const BASE_HEIGHT = 600;
      const scaleX = 1024 / BASE_WIDTH;
      const scaleY = 600 / BASE_HEIGHT;

      const cardOffsets = [
        { x: 0, y: 40 }, { x: 0, y: 10 }, { x: 30, y: -20 }, { x: 30, y: 10 },
        { x: 0, y: -20 }, { x: 0, y: -50 }, { x: -5, y: -20 },
        { x: -30, y: 10 }, { x: -30, y: -20 }, { x: -5, y: 10 }
      ];
      const hudOffsets = [
        { x: 130, y: 40 }, { x: 50, y: 10 }, { x: 135, y: -30 }, { x: 150, y: 15 },
        { x: 50, y: 30 }, { x: 130, y: -10 }, { x: 200, y: 30 },
        { x: 110, y: 15 }, { x: 110, y: -30 }, { x: 200, y: 10 }
      ];

      const angleMap = Array.from({ length: 10 }, (_, i) => -90 + (i * 360 / 10));
      const radiusX = 360 - 100;
      const radiusY = 210 - 50;

      players.forEach((p) => {
        const i = p.seatIndex ?? 0;
        const angle = angleMap[i] * (Math.PI / 180);
        const offset = cardOffsets[i];

        p.cardX = 512 + Math.cos(angle) * radiusX + offset.x * scaleX;
        p.cardY = 300 + Math.sin(angle) * radiusY + offset.y * scaleY;

        if (!p.card) return;
        if (animCard && animCard.progress < 1 && (i === animCard.fromIndex || i === animCard.toIndex)) return;

        const rankMap = { J: 'jack', Q: 'queen', K: 'king', A: 'ace' };
        const suitMap = { S: 'spades', H: 'hearts', D: 'diamonds', C: 'clubs' };
        const rank = typeof p.card.rank === 'number' ? p.card.rank : rankMap[p.card.rank];
        const suit = suitMap[p.card.suit];
        const key = `${rank}_of_${suit}`;

        const show = showCards || showAllCards || (p.id === mySocketId && peekPlayerCard) || p.card.rank === 'K';
        const cardImg = cardImages[show ? key : 'back'];

        if (cardImg?.complete) {
          const scale = cardImg === cardImages['back'] ? 1.0 : 0.95;
          ctx.drawImage(cardImg, p.cardX - 20, p.cardY - 27.5, 40 * scale, 55 * scale);
        } else {
          ctx.fillStyle = "red";
          ctx.fillRect(p.cardX - 20, p.cardY - 27.5, 40, 55);
        }
      });

      if (animCard && animCard.fromIndex != null && animCard.toIndex != null) {
        const from = players[animCard.fromIndex];
        const to = players[animCard.toIndex];
        if (from && to && from.cardX != null && to.cardX != null) {
          const x = from.cardX + (to.cardX - from.cardX) * animCard.progress;
          const y = from.cardY + (to.cardY - from.cardY) * animCard.progress;
          const cardImg = cardImages['back'];
          if (cardImg?.complete) ctx.drawImage(cardImg, x - 20, y - 27.5, 40, 55);
          else { ctx.fillStyle = "blue"; ctx.fillRect(x - 20, y - 27.5, 40, 55); }
        }
      }

      const container = document.getElementById('playerContainer');
      container.innerHTML = '';

      const hudNudges = [
        { x: 0, y: 40 }, { x: 0, y: 10 }, { x: 30, y: -20 }, { x: 30, y: 10 },
        { x: 0, y: -20 }, { x: 0, y: -50 }, { x: -5, y: -20 },
        { x: -30, y: 10 }, { x: -30, y: -20 }, { x: -5, y: 10 }
      ];

      players.forEach((p) => {
        const i = p.seatIndex ?? 0;
        const angle = angleMap[i] * (Math.PI / 180);
        const baseX = 512 + Math.cos(angle) * (360 + 30);
        const baseY = 300 + Math.sin(angle) * (210 + 30);
        const offset = hudNudges[i];
        const x = baseX + offset.x * (1024 / 1024);
        const y = baseY + offset.y * (600 / 600);

        const div = document.createElement('div');
        div.className = 'player-ui';
        div.id = `player-ui-${p.id}`;
        div.innerHTML = `
          <div class="hud">
            <div class="name" style="${p.id.startsWith('bot_') ? 'color: #666; opacity: 0.7;' : ''}">${p.name}</div>
            <img class="avatar" src="./assets/avatar.png" style="${p.id.startsWith('bot_') ? 'opacity: 0.5;' : ''}" />
            <div class="chips">
              <img src="./assets/coin.png" style="height:14px; vertical-align:middle;" />
              ${p.chips}
            </div>
          </div>
        `;
        div.style.left = `${x}px`;
        div.style.top = `${y}px`;
        div.style.transform = 'translate(-50%, -50%)' + (i === currentPlayer && p.chips > 0 ? ' scale(1.05)' : '');
        const avatarEl = div.querySelector('.avatar');
        avatarEl.classList.toggle('active-glow', i === currentPlayer && p.chips > 0);
        container.appendChild(div);
      });
    }

    function animateCardPass(timestamp) {
      if (!animCard || !animationInProgress) return;
      const duration = 500;
      if (!animStartTime) animStartTime = timestamp;
      const elapsed = timestamp - animStartTime;
      const easeInOut = t => t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
      animCard.progress = easeInOut(Math.min(elapsed / duration, 1));
      drawTable(false, animCard);
      if (animCard.progress < 1) requestAnimationFrame(animateCardPass);
      else { animCard = null; animationInProgress = false; drawTable(); }
    }

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', () => {
      socket = io();
      mySocketId = socket.id;

      socket.on('connect', () => {
        socket.emit('requestLobbyState');
      });

      socket.on('lobbyUpdate', (games) => updateLobby(games));

      socket.on('roomCreated', (roomCode) => {
        myRoom = roomCode;
        const cr = document.getElementById('current-room');
        if (cr) cr.textContent = `Joined: ${roomCode}`;
        updateLobby();
      });

      socket.on('playerList', (playersList) => {
        const pi = document.getElementById('player-info');
        if (pi) pi.dataset.room = myRoom || '';
        updatePlayerInfo(playersList.find(p => p.id === mySocketId));
        const listEl = document.getElementById('playerList');
        if (listEl) {
          listEl.innerHTML = '';
          playersList.forEach(p => {
            const li = document.createElement('li');
            li.innerText = p.name;
            listEl.appendChild(li);
          });
        }
        const humanCount = playersList.filter(p => !p.id.startsWith('bot_')).length;
        const startBtn = document.getElementById('startBtn');
        if (startBtn) startBtn.disabled = humanCount < 2;
      });

      socket.on('joinedRoom', (data) => {
        myRoom = data.roomCode;
        players = data.players;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        const playerListEl = document.getElementById('playerList');
        if (playerListEl) playerListEl.innerHTML = players.map(p => `<li>${p.name}</li>`).join('');
      });

      socket.on('gameStarted', (state) => {
        gameState = state;
        players = state.players;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        preloadAssets().then(() => { drawTable(); });
      });

      socket.on('turnUpdate', ({ currentPlayerId, players: updatedPlayers }) => {
        gameState.players = updatedPlayers;
        gameState.currentPlayerId = currentPlayerId;
        players = updatedPlayers;
        myTurn = (mySocketId === currentPlayerId);
        peekPlayerCard = myTurn;
        updateTurnIndicator();
        drawTable();
        const actionBtns = document.getElementById('actionBtns');
        const passBtn = document.getElementById('passBtn');
        const keepBtn = document.getElementById('keepBtn');
        if (actionBtns && passBtn && keepBtn) {
          actionBtns.style.display = myTurn ? 'block' : 'none';
          const cp = players.find(p => p.id === currentPlayerId);
          const canPass = !(cp && cp.card && cp.card.rank === 'K');
          passBtn.disabled = !myTurn || !canPass;
          keepBtn.disabled = !myTurn;
        }
      });

      socket.on('cardPassed', ({ fromIndex, toIndex }) => {
        const toPlayer = players[toIndex];
        if (toPlayer && toPlayer.card && toPlayer.card.rank === 'K') {
          showMessage(`${toPlayer.name} has a King and cannot be passed to!`, 3000, "#f00");
          return;
        }
        drawTable();
        animCard = { fromIndex, toIndex, progress: 0 };
        animStartTime = null;
        animationInProgress = true;
        requestAnimationFrame(animateCardPass);
      });

      socket.on('roundEnded', ({ updatedPlayers, losers }) => {
        gameState.players = updatedPlayers;
        updatedPlayers.forEach((u, i) => {
          if (!players[i]) players[i] = { ...u };
          else { players[i].card = u.card; players[i].chips = u.chips; players[i].eliminated = u.eliminated; }
        });
        myTurn = false; peekPlayerCard = false; animCard = null;
        showAllCards = true; drawTable(false, animCard);
        const frozenPlayers = [...players];
        setTimeout(() => { showAllCards = false; players = frozenPlayers; drawTable(); }, 6500);

        const alertMessage = "💥 Round ended! Lost a chip: " + losers
          .map(loser => {
            const snapshot = updatedPlayers.find(p => p.name === loser.name);
            if (!snapshot || !snapshot.card) return `${loser.name} (?)`;
            return `${loser.name} (${snapshot.card.rank}${snapshot.card.suit})`;
          }).join(", ");
        const alertBox = document.createElement("div");
        alertBox.style.position = "fixed";
        alertBox.style.top = "20px";
        alertBox.style.left = "50%";
        alertBox.style.transform = "translateX(-50%)";
        alertBox.style.padding = "15px 25px";
        alertBox.style.background = "#222";
        alertBox.style.border = "2px solid #f00";
        alertBox.style.color = "#fff";
        alertBox.style.fontSize = "16px";
        alertBox.style.zIndex = "1000";
        alertBox.style.boxShadow = "0 0 10px red";
        alertBox.innerText = alertMessage;
        document.body.appendChild(alertBox);
        setTimeout(() => { document.body.removeChild(alertBox); }, 4500);
      });

      socket.on('errorMessage', (msg) => { showMessage(msg, 3000, "#f00"); });

      socket.on('gameOver', ({ winner }) => {
        document.getElementById('winMessage').innerText = `${winner.name} Wins!`;
        document.getElementById('endOverlay').style.display = 'flex';
      });

      backgroundImage.src = './assets/background.png';
      backgroundImage.onerror = () => {
        const ctx = document.querySelector('canvas').getContext('2d');
        ctx.fillStyle = '#222'; ctx.fillRect(0, 0, 1024, 600);
      };

      function preloadAssets() {
        const suits = ['clubs', 'diamonds', 'hearts', 'spades'];
        const ranks = [2, 3, 4, 5, 6, 7, 8, 9, 10, 'jack', 'queen', 'king', 'ace'];
        const loadPromises = [];
        for (let s of suits) {
          for (let r of ranks) {
            const img = new Image();
            const key = `${r}_of_${s}`;
            img.src = `./assets/${key}.png`;
            cardImages[key] = img;
            loadPromises.push(new Promise(resolve => { img.onload = resolve; img.onerror = resolve; }));
          }
        }
        const back = new Image(); back.src = './assets/back.png'; cardImages['back'] = back;
        loadPromises.push(new Promise(resolve => { back.onload = resolve; back.onerror = resolve; }));
        return Promise.all(loadPromises);
      }

      // Initialize canvas and wrapper
      const wrapper = document.createElement('div');
      wrapper.style.position = 'absolute';
      wrapper.style.left = '50%';
      wrapper.style.top = '50%';
      wrapper.style.transform = 'translate(-50%, -50%)';
      wrapper.style.width = '1024px';
      wrapper.style.height = '600px';
      wrapper.style.overflow = 'hidden';
      wrapper.style.zIndex = '1';

      const canvas = document.createElement('canvas');
      canvas.width = 1024; canvas.height = 600;
      canvas.style.display = 'block'; canvas.style.width = '100%'; canvas.style.height = '100%';

      wrapper.appendChild(canvas);
      const hudContainer = document.getElementById("playerContainer");
      wrapper.appendChild(hudContainer);
      document.body.appendChild(wrapper);

      function resizeGame() {
        const scaleX = window.innerWidth / 1024;
        const scaleY = window.innerHeight / 600;
        const scale = Math.min(scaleX, scaleY);
        wrapper.style.transform = `translate(-50%, -50%) scale(${scale})`;
      }
      window.addEventListener('resize', resizeGame);
      resizeGame();
    });

    /* ===== Bridge the NEW lobby UI to your existing Socket.IO code ===== */

// Keep a cache of rooms to render the new table
let _roomsCache = [];
let myRooms = new Set();

// Hook up the new buttons/tabs once the page is ready
document.addEventListener('DOMContentLoaded', () => {
  // Clock in the left panel
  const clockEl = document.getElementById('clock');
  if (clockEl) setInterval(() => { clockEl.textContent = new Date().toLocaleTimeString(); }, 1000);

  // Join-by-code button
  const btnJoinCode = document.getElementById('btn-join-code');
  if (btnJoinCode) {
    btnJoinCode.addEventListener('click', () => {
      const name = (document.getElementById('usernameInput')?.value || '').trim();
      const room = (document.getElementById('roomInput')?.value || '').trim();
      if (!name || !room) return alert('Enter your name and room code.');
      myUsername = name;
      joinGame(room);    // uses your existing join function
    });
  }

  // Create table button (sends optional metadata – ok if server ignores it)
  const btnCreate = document.getElementById('btn-create');
  if (btnCreate) {
    btnCreate.addEventListener('click', () => {
      const name = (document.getElementById('usernameInput')?.value || '').trim();
      if (!name) return alert('Please enter a name.');
      myUsername = name;
      const opts = {
        type: document.getElementById('sel-type')?.value,
        stakes: document.getElementById('sel-stakes')?.value,
        speed: document.getElementById('sel-speed')?.value
      };
      socket.emit('createGame', { username: myUsername, options: opts });
    });
  }

  // Tabs (All / My / Tournaments)
  document.querySelectorAll('.l-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.l-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentTab = btn.dataset.tab;   // reuses your currentTab variable
      renderRoomsFromCache();
    });
  });
});

// Render the polished table (right panel)
function renderRoomsFromCache() {
  const body = document.getElementById('rooms-body');
  if (!body) return;
  body.innerHTML = '';

  let list = _roomsCache.slice();

  if (currentTab === 'my') {
    // Show only the room we're in (simple "My Games" for now)
    const currentRoom = (document.getElementById('player-info') || {}).dataset?.room;
    list = currentRoom ? list.filter(r => r.roomCode === currentRoom) : [];
  }

  if (currentTab === 'tournaments') {
    body.innerHTML = `<tr class="l-row"><td colspan="6" style="padding:16px">Tournaments – coming soon!</td></tr>`;
    return;
  }

  const onlineEl = document.getElementById('players-online');
  if (onlineEl) onlineEl.textContent = String(list.reduce((sum, r) => sum + (r.playerCount || 0), 0));

  list.forEach(r => {
    const tr = document.createElement('tr');
    tr.className = 'l-row';
    const status = r.status === 'Full'
      ? `<span class="l-status full">Full</span>`
      : `<span class="l-status ok">Open</span>`;

    tr.innerHTML = `
      <td><span class="l-pill">${(r.roomCode || '').slice(0,6)}</span></td>
      <td>${r.type || '-'}</td>
      <td>${r.stakes || '-'}</td>
      <td>${r.playerCount || 0}/${r.maxPlayers || 0}</td>
      <td>${status}</td>
      <td style="text-align:right">
        <button class="l-tab" data-join="${r.roomCode}" style="padding:6px 10px">Join</button>
      </td>
    `;
    body.appendChild(tr);
    tr.querySelector('[data-join]').addEventListener('click', () => joinGame(r.roomCode));
  });
}

// Keep your original updateLobby for the legacy view, but *also* feed the new table.
const __originalUpdateLobby = updateLobby;  // your existing function above
updateLobby = function(games = []) {
  _roomsCache = games;
  renderRoomsFromCache();
  if (typeof __originalUpdateLobby === 'function') __originalUpdateLobby(games);
};

// When you create or join, remember the room for "My Games"
if (typeof io !== 'undefined') {
  document.addEventListener('DOMContentLoaded', () => {
    // after socket is set up in your code:
    socket?.on?.('roomCreated', (roomCode) => { if (roomCode) myRooms.add(roomCode); });
    socket?.on?.('joinedRoom',  (data) => { if (data?.roomCode) myRooms.add(data.roomCode); });
  });
}
/* ===== End bridge ===== */

  </script>
</body>
</html>
