<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pass the Ace - Deluxe Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0; 
      background: #111; 
      overflow: hidden; 
      color: white; 
      font-family: 'Orbitron', sans-serif;
    }
    canvas {
      display: block;
    }
    #ui {
      position: absolute; 
      bottom: 40px; 
      right: 40px; 
      text-align: right; 
      z-index: 10;
    }
    button {
      margin: 5px; 
      padding: 12px 25px; 
      font-size: 18px;
      background: linear-gradient(45deg, #444, #888); 
      color: #fff;
      border: none; 
      border-radius: 10px; 
      cursor: pointer;
      box-shadow: 0 0 10px #00f7ff; 
      transition: 0.3s;
    }
    button:hover {
      background: linear-gradient(45deg, #666, #aaa); 
      box-shadow: 0 0 20px #00f7ff;
    }
    /* New disabled style for buttons */
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    #turnIndicator {
      position: absolute; 
      top: 60px; 
      width: 100%;
      text-align: center; 
      font-size: 20px; 
      color: #0ff; 
      text-shadow: 0 0 5px #0ff;
    }
    #endOverlay {
      display: none; 
      position: absolute; 
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.85);
      color: white; 
      font-size: 32px; 
      display: flex;
      align-items: center; 
      justify-content: center;
      flex-direction: column; 
      z-index: 20;
    }
    #endOverlay button {
      font-size: 22px; 
      margin-top: 20px;
      background: #28a745; 
      box-shadow: 0 0 15px #28a745;
    }
    #playerContainer {
      position: absolute; 
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%; 
      pointer-events: none;
    }
    .player-ui {
      position: absolute; 
      display: flex;
      align-items: center; 
      gap: 8px;
      color: white; 
      font-family: 'Orbitron', sans-serif;
      pointer-events: none;
    }
    .hud {
      display: flex; 
      flex-direction: column;
      align-items: center; 
      pointer-events: none; 
      gap: 3px;
    }
    .hud .name {
      background: #000; 
      color: white; 
      font-size: 10px;
      padding: 2px 8px; 
      border-radius: 20px; 
      text-align: center;
    }
    .hud .avatar {
      width: 42px; 
      height: 42px; 
      border-radius: 50%;
      border: 2px solid white; 
      box-shadow: 0 0 4px #000;
    }
    .hud .avatar.active-glow {
      box-shadow: 0 0 12px 4px #00f7ff, 0 0 24px 6px #0ff;
      border-color: #0ff;
    }
    .hud .chips {
      font-size: 10px; 
      color: gold; 
      background: none;
      padding: 1px 4px; 
      border-radius: 10px;
      display: flex; 
      align-items: center; 
      gap: 2px;
    }
  </style>
</head>
<body>
  <!-- Multiplayer Lobby -->
  <div id="lobby" style="position:absolute;top:0;left:0;width:100%;height:100%;background:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50;">
    <h2 style="color:white;">Join Game</h2>
    <input id="usernameInput" type="text" placeholder="Enter your name" style="padding:10px; font-size:16px; border-radius:5px; border:none; margin-bottom:10px;">
    <input id="roomInput" type="text" placeholder="Enter room code" style="padding:10px; font-size:16px; border-radius:5px; border:none; margin-bottom:10px;">
    <button onclick="joinGame()">Join Game</button>
  </div>

  <!-- Main UI (hidden at first) -->
  <div id="ui" style="display:none;">
    <button id="startBtn" onclick="startGame()" disabled>Start Game</button><br>
    <div id="actionBtns" style="display:none;">
      <button id="keepBtn" onclick="keepCard()">Keep</button>
      <button id="passBtn" onclick="passCard()">Pass</button>
    </div>
  </div>

  <div id="turnIndicator"></div>
  <div id="endOverlay">
    <div id="winMessage">Player X Wins!</div>
    <button onclick="restartGame()">Play Again</button>
  </div>
  <div id="playerContainer"></div>
  <div id="players" style="position:absolute; top:10px; left:10px; z-index:100; font-size:14px; background:#222; padding:10px; border-radius:8px; box-shadow: 0 0 10px #0ff;">
    <strong>Players:</strong>
    <ul id="playerList" style="list-style:none; padding-left: 0; margin-top: 5px;"></ul>
  </div>

  <script>
    // Create and setup canvas
    const canvas = document.createElement('canvas');
    canvas.width = 1024;
    canvas.height = 600;
    canvas.style.display = 'block';
    canvas.style.margin = '0 auto';
    canvas.style.position = 'absolute';
    canvas.style.left = '50%';
    canvas.style.top = '50%';
    canvas.style.transform = 'translate(-50%, -50%)';
    document.body.insertBefore(canvas, document.getElementById('playerContainer'));
    const ctx = canvas.getContext('2d');

    // Load background and assets
    const backgroundImage = new Image();
    backgroundImage.src = './assets/background.png';
    const CARD_W = 40, CARD_H = 55;
    const CENTER_X = 512, CENTER_Y = 300;
    let X_RADIUS = 360, Y_RADIUS = 210;
    let players = [], dealerIndex = null, currentPlayer = 0, deck = [];
    let isHumanTurn = false, peekPlayerCard = false, startingPlayerIndex = null;
    let gameRunning = false;
    let eliminatedPlayers = []; // Track spectators

    let animCard = null;
    let animStartTime = null;


    // Asset preload
    function preloadAssets() {
      let cardImages = {};
      window.cardImages = cardImages;
      const suits = ['clubs', 'diamonds', 'hearts', 'spades'];
      const ranks = [2,3,4,5,6,7,8,9,10,'jack','queen','king','ace'];
      const loadPromises = [];

      for (let s of suits) {
        for (let r of ranks) {
          const img = new Image();
          const src = `./assets/${r}_of_${s}.png`;
          img.src = src;
          cardImages[`${r}_${s}`] = img;
          loadPromises.push(new Promise((resolve) => {
            img.onload = resolve;
            img.onerror = resolve;
          }));
        }
      }

      const back = new Image();
      back.src = './assets/Back.png';
      cardImages['Back'] = back;
      loadPromises.push(new Promise((resolve) => {
        back.onload = resolve;
        back.onerror = resolve;
      }));

      return Promise.all(loadPromises);
    }

    // Update turn indicator text
    function updateTurnIndicator() {
      document.getElementById("turnIndicator").innerText = `Player ${players[currentPlayer]?.id}'s Turn`;
    }

    function restartGame() {
      document.getElementById("endOverlay").style.display = "none";
      document.getElementById("startBtn").style.display = "block";
      dealerIndex = null;
      startGame();
    }

    // Emit startGame event to server
    function startGame() {
      const myRoom = localStorage.getItem('room');
const myUsername = localStorage.getItem('username');
socket.emit("join", { username: myUsername, room: myRoom });
    }

    // Updated action functions with extra input locking
    function passCard() {
      if (!myTurn) return;
      myTurn = false; // lock input immediately
      document.getElementById("actionBtns").style.display = "none";
      socket.emit("passCard", { room: myRoom });
    }

    function keepCard() {
      if (!myTurn) return;
      myTurn = false;
      document.getElementById("actionBtns").style.display = "none";
      socket.emit("keepCard", { room: myRoom });
    }

    // AI and turn processing functions (client-side display only; game logic is server-controlled)
    function drawTable(showCards = false, animCard = null) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (backgroundImage.complete) ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);

  const cardOffsets = [
    { x: 0, y: 40 }, { x: 0, y: 10 }, { x: 30, y: -20 }, { x: 30, y: 10 },
    { x: 0, y: -20 }, { x: 0, y: -50 }, { x: -5, y: -20 },
    { x: -30, y: 10 }, { x: -30, y: -20 }, { x: -5, y: 10 }
  ];
  const hudOffsets = [
    { x: 130, y: 40 }, { x: 50, y: 10 }, { x: 135, y: -30 }, { x: 150, y: 15 },
    { x: 50, y: 30 }, { x: 130, y: -10 }, { x: 200, y: 30 },
    { x: 110, y: 15 }, { x: 110, y: -30 }, { x: 200, y: 10 }
  ];
  const angleMap = Array.from({ length: 10 }, (_, i) => -90 + (i * 360 / 10));
  const radiusX = X_RADIUS - 100, radiusY = Y_RADIUS - 50;

  // Draw cards
  players.forEach((p) => {
    const i = p.seatIndex ?? 0;
    const angle = angleMap[i] * (Math.PI / 180);
    const offset = cardOffsets[i];
    p.cardX = CENTER_X + Math.cos(angle) * radiusX + offset.x;
    p.cardY = CENTER_Y + Math.sin(angle) * radiusY + offset.y;

    if (!p.card || p.eliminated) return;

// Skip drawing card for both FROM and TO players during the pass
if (animCard && animCard.progress < 1 && (i === animCard.fromIndex || i === animCard.toIndex)) return;



    const show = showCards || (p.id === socket.id && peekPlayerCard) || p.card.rank === 'K';
    const rankMap = { J: 'jack', Q: 'queen', K: 'king', A: 'ace' };
    const suitMap = { S: 'spades', H: 'hearts', D: 'diamonds', C: 'clubs' };
    const rank = typeof p.card.rank === 'number' ? p.card.rank : rankMap[p.card.rank];
    const suit = suitMap[p.card.suit];
    const cardImg = cardImages[show ? `${rank}_${suit}` : 'Back'];
    if (cardImg?.complete) {
      const scale = cardImg === cardImages['Back'] ? 1.0 : 0.95;
      ctx.drawImage(cardImg, p.cardX - CARD_W / 2, p.cardY - CARD_H / 2, CARD_W * scale, CARD_H * scale);
    }
  });

  // Draw animated passing card
  // ðŸ” Animate passing card (if active)
if (animCard && animCard.fromIndex != null && animCard.toIndex != null) {
  const from = players[animCard.fromIndex];
  const to = players[animCard.toIndex];

  if (from && to && from.cardX != null && to.cardX != null) {
    const x = from.cardX + (to.cardX - from.cardX) * animCard.progress;
    const y = from.cardY + (to.cardY - from.cardY) * animCard.progress;

    const cardImg = cardImages['Back'];
    if (cardImg?.complete) {
      ctx.drawImage(cardImg, x - CARD_W / 2, y - CARD_H / 2, CARD_W, CARD_H);
    }
  }

  // ðŸ”„ Progress animation
  const now = performance.now();
  const elapsed = now - animStartTime;
  animCard.progress = Math.min(elapsed / 500, 1); // 0.5s

  if (animCard.progress < 1) {
    requestAnimationFrame(() => drawTable(false, animCard));
  } else {
    animCard = null;
  }
}


  // Draw player HUD
  const container = document.getElementById('playerContainer');
  container.innerHTML = '';
  players.forEach((p) => {
    const i = p.seatIndex ?? 0;
    const angle = angleMap[i] * (Math.PI / 180);
    const offset = hudOffsets[i];
    const outerX = X_RADIUS + 30, outerY = Y_RADIUS + 30;
    const x = CENTER_X + Math.cos(angle) * outerX + offset.x;
    const y = CENTER_Y + Math.sin(angle) * outerY + offset.y;

    const div = document.createElement('div');
    div.className = 'player-ui';
    div.id = `player-ui-${p.id}`;
    div.innerHTML = `
      <div class="hud">
        <div class="name">${p.name}</div>
        <img class="avatar" src="./assets/avatar.png" />
        <div class="chips">
          <img src="./assets/coin.png" style="height:14px; vertical-align:middle;" />
          ${p.chips}
        </div>
      </div>
    `;
    div.style.left = `${x}px`;
    div.style.top = `${y}px`;
    div.style.transform = 'translate(-50%, -50%)' + (i === currentPlayer && p.chips > 0 ? ' scale(1.05)' : '');
    const avatarEl = div.querySelector('.avatar');
    avatarEl.classList.toggle('active-glow', i === currentPlayer && p.chips > 0);
    container.appendChild(div);
  });

  // Handle animation progression
  if (animCard) {
    const now = performance.now();
    const elapsed = now - animStartTime;
    animCard.progress = Math.min(elapsed / 500, 1); // 0.5s animation

    if (animCard.progress < 1) {
      requestAnimationFrame(() => drawTable(false, animCard));
    } else {
      animCard = null;
    }
  }
}

    // Preload assets then enable the Start Game button
    preloadAssets().then(() => {
      document.getElementById("startBtn").disabled = false;
    });
  </script>

  <!-- Multiplayer Socket Setup -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let mySocketId = "";
    let myUsername = "";
    let myRoom = "";
    let myTurn = false;
    let gameState = {};

    function joinGame() {
      const name = document.getElementById("usernameInput").value.trim();
      const room = document.getElementById("roomInput").value.trim();
      if (!name || !room) {
        return alert("Please enter both a name and a room code.");
      }
      myUsername = name;
      myRoom = room;
      socket.emit("join", { username: name, room });
      document.getElementById("lobby").style.display = "none";
      document.getElementById("ui").style.display = "block";
      document.getElementById("endOverlay").style.display = "none";
      document.getElementById("startBtn").style.display = "block";
    }

    function startGame() {
      socket.emit("startGame", myRoom);
    }

    // Pass and keep functions already defined above

    socket.on("welcome", (msg) => {
      console.log("âœ…", msg);
      mySocketId = socket.id; // store your socket ID for UI reference
    });

    socket.on("playerList", (playersList) => {
      console.log("ðŸ“‹ Current Players:", playersList);
      const listEl = document.getElementById("playerList");
      listEl.innerHTML = "";
      playersList.forEach(p => {
        const li = document.createElement("li");
        li.innerText = p.name;
        listEl.appendChild(li);
      });
    });

    socket.on("gameStarted", (state) => {
      console.log("ðŸŽ® Game started:", state);
      gameState = state;
      players = state.players;
      drawTable();  // render initial table state from server gameState
    });

    socket.on("turnUpdate", ({ currentPlayerId, players: updatedPlayers }) => {
  gameState.players = updatedPlayers;
  players = updatedPlayers;
  myTurn = (socket.id === currentPlayerId);
  peekPlayerCard = myTurn; // âœ… This line ensures you can see your card

  // Update turn indicator and button state
  updateTurnIndicator();
  drawTable();

  const actionBtns = document.getElementById("actionBtns");
  const buttons = document.querySelectorAll("#actionBtns button");
  if (myTurn) {
    actionBtns.style.display = "block";
    buttons.forEach(btn => btn.disabled = false);
  } else {
    actionBtns.style.display = "none";
    buttons.forEach(btn => btn.disabled = true);
  }
});

socket.on('cardPassed', ({ fromIndex, toIndex }) => {
  console.log("Animating pass:", fromIndex, "â†’", toIndex); // Optional debug
  animCard = { fromIndex, toIndex, progress: 0 };
  animStartTime = performance.now();
  drawTable(false, animCard); // ðŸ”¥ Kick off animation loop
});



    socket.on("roundEnded", ({ updatedPlayers, losers }) => {
  gameState.players = updatedPlayers;
  players = updatedPlayers;
  myTurn = false;

  // âœ… Clear any leftover animation before drawing
  animCard = null;

  drawTable(false, animCard); // âœ… Explicitly pass animCard

  alert("ðŸ’¥ Round ended! Lost a chip: " + losers.map(p => p.name).join(", "));
});


    socket.on("errorMessage", (msg) => {
      alert(msg);
    });
  </script>
</body>
</html>
